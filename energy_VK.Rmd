---
title: "Statistical potential for CDR:antigen contacts (VK)"
output: html_document
---

###Misha part starts

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(forcats)
library(ggrepel)
library(broom)
select = dplyr::select
```

```{r}
library(rstatix)
library(ggpubr)
library(ggbeeswarm)
merge = merge.data.frame
summarise = dplyr::summarise
summarize = dplyr::summarise
rename = dplyr::rename
mutate = dplyr::mutate
```

```{r}
contacts <- fread("zcat out/atomdist.txt.gz") %>%
  filter(dist <= 5, chain.id.from != chain.id.to) %>%
  select(-atom.from, -atom.to, -dist) %>%
  unique

contacts.1 <- contacts
contacts.1$chain.id.from <- contacts$chain.id.to
contacts.1$chain.id.to <- contacts$chain.id.from
contacts.1$residue.index.from <- contacts$residue.index.to
contacts.1$residue.index.to <- contacts$residue.index.from

contacts <- contacts %>%
  rbind(contacts.1)
```

```{r}
resmarkup <- fread("out/resmarkup.txt", blank.lines.skip = T)

general <- fread("out/general.txt")

resmarkup.a <- resmarkup %>%
  merge(general)

contacts.a <- contacts %>%
  merge(resmarkup.a %>% mutate(chain.id.from = chain.id,
                               chain.type.from = chain.type,
                               chain.supertype.from = chain.supertype,
                               region.type.from = region.type,
                               residue.index.from = residue.index,
                               residue.aa.from = residue.aa) %>%
          select(pdb.id, chain.id.from, chain.type.from, chain.supertype.from,
                 complex.species,
                 region.type.from, residue.index.from, residue.aa.from)) %>%
  merge(resmarkup.a %>% mutate(chain.id.to = chain.id,
                               chain.type.to = chain.type,
                               chain.supertype.to = chain.supertype,
                               region.type.to = region.type,
                               residue.index.to = residue.index,
                               residue.aa.to = residue.aa) %>%
          select(pdb.id, chain.id.to, chain.type.to, chain.supertype.to,
                 region.type.to, residue.index.to, residue.aa.to)
        #, by = c("pdb.id", "chain.id.to", "residue.index.to") 
  )
```

Cluster TCRs based on CDR3a and CDR3b sequence similarity and
filter contacts based on TCR clusters
```{r Vadim}
library(stringdist)

markup <- read.table("out/markup.txt", fill = T, header = T) %>%
  merge(general %>%
          select(-chain.component, -chain.supertype, -seq.length))
markup.a <- markup %>%
    filter(chain.type == "TRA" & region.type == "CDR3") %>%
    select(pdb.id, CDR3a = region.sequence) %>%
    unique() %>%
  merge(markup %>%
    filter(chain.type == "TRB" & region.type == "CDR3") %>%
    select(pdb.id, CDR3b = region.sequence) %>%
    unique())

dist.cdr3 <- expand.grid(pdb.id.1 = markup.a$pdb.id, pdb.id.2 = markup.a$pdb.id) %>%
  merge(markup.a %>% select(pdb.id.1 = pdb.id, CDR3a.1 = CDR3a, CDR3b.1 = CDR3b)) %>%
  merge(markup.a %>% select(pdb.id.2 = pdb.id, CDR3a.2 = CDR3a, CDR3b.2 = CDR3b)) %>%
  mutate(dist.cdr3a = stringdist(CDR3a.1, CDR3a.2, method = 'hamming'),
         dist.cdr3b = stringdist(CDR3b.1, CDR3b.2, method = 'hamming')) %>%
  mutate_each(funs(replace(., . == Inf, 1000))) #as Inf values aren't supported in hclust
  

clusters_cdr3 <- function(column.with.dist.cdr3) {
dist.cdr3 %>%
  select(pdb.id.1, pdb.id.2, dist = column.with.dist.cdr3) %>%
  spread(pdb.id.2, dist) %>%
  column_to_rownames("pdb.id.1") %>%
  as.dist() %>%
  hclust() %>%
  cutree(h = 3)
}

#renumber residues from start of region (e.g. CDR)
contacts.a <- contacts.a %>%
  merge(markup %>%
          select(pdb.id, region.type.from = region.type, chain.id.from = chain.id,
                 region.start.from = region.start, chain.type.from = chain.type)) %>% 
  merge(markup %>% 
          select(pdb.id, region.type.to = region.type, chain.id.to = chain.id,
                 region.start.to = region.start, chain.type.to = chain.type)) %>%
  mutate(residue.index.from.0 = residue.index.from - region.start.from,
         residue.index.to.0 = residue.index.to - region.start.to) 
  
#filter unique contacts
contacts.a <- contacts.a %>%
  mutate(cluster.cdr3a = clusters_cdr3("dist.cdr3a")[pdb.id],
         cluster.cdr3b = clusters_cdr3("dist.cdr3b")[pdb.id]) %>%
  distinct_at(vars(-pdb.id, -residue.index.from, -residue.index.to), .keep_all = T)
```


Summarize

```{r}
contacts.a.1 <- contacts.a %>%
  filter(chain.supertype.from != chain.supertype.to) %>%
  group_by(type = "all", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

contacts.a.2 <- contacts.a %>%
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE" | 
           startsWith(region.type.to, "CDR") & region.type.from == "PEPTIDE") %>%
  group_by(type = "cdrps", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

contacts.a.3 <- contacts.a %>%
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE") %>%
  group_by(type = "cdrpa", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

#contacts.a.4 <- contacts.a %>%
#  filter(startsWith(region.type.from, "CDR") & startsWith(region.type.to, "CDR")) %>%
#  group_by(type = "cdrpx", residue.aa.from, residue.aa.to) %>%
#  summarize(count = n())
```



```{r}
aas <- unique(contacts.a.1$residue.aa.from)
tmp <- expand.grid(type = c("all", "cdrps", "cdrpa"),
                   residue.aa.from = aas, 
                   residue.aa.to = aas) %>%
  as.data.frame
contacts.a.x <- list(
  contacts.a.1,
  contacts.a.2,
  contacts.a.3#,
  #contacts.a.4
) %>%
  rbindlist %>%
  merge(tmp, all = T) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  mutate(count = count + 1)
```

Normalize

```{r}
contacts.a.s <- contacts.a.x %>%
  group_by(type, residue.aa.from) %>%
  mutate(total.to = sum(count)) %>%
  group_by(type, residue.aa.to) %>%
  mutate(total.from = sum(count)) %>%
  ungroup %>%
  group_by(type) %>%
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from))
```

Symmetrize (for cdrpa)

```{r}
contacts.a.s.1 <- contacts.a.s
contacts.a.s.1$residue.aa.to <- contacts.a.s$residue.aa.from
contacts.a.s.1$residue.aa.from <- contacts.a.s$residue.aa.to

contacts.a.s <- contacts.a.s %>%
  rbind(contacts.a.s.1) %>%
  group_by(type, residue.aa.from, residue.aa.to) %>%
  summarize(count = mean(count),
            total.to = mean(total.to),
            total.from = mean(total.from),
            total = mean(total),
            odds = mean(odds))

contacts.a.s <- contacts.a.s %>%
  group_by(type, residue.aa.from) %>%
  mutate(E1 = -mean(odds)) %>%
  group_by(type, residue.aa.to) %>%
  mutate(E2 = -mean(odds)) %>%
  group_by(type) %>%
  mutate(E12 = -odds - E1 - E2) %>%
  ungroup
```

```{r}
contacts.a.s %>%
  filter(type == "cdrpa") %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = count)) +
  geom_tile() +
  geom_text(aes(label = round(count))) +
  scale_fill_distiller(palette = "Blues", direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(aspect = 1) 

contacts.a.s %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = odds)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral", limits = c(-2.9, 2.9)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1) 

contacts.a.s %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = E12)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral", limits = c(-2.3, 2.3)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1)

contacts.a.s %>%
  select(type, residue.aa.from, E1) %>%
  unique %>%
  ggplot(aes(x = residue.aa.from, y = E1, fill = E1)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_distiller(palette = "Spectral", limits = c(-0.4, 0.4)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1)
```


```{r Vadim}
aa.levels <- c("L","F","I","M","V","W","Y","C","H","A","G","P","T","S","Q","N","D","E","R","K")

aa.classes <- tibble (  
  aa = c("A", "I", "L", "V", "M","G", "P",
         "R",  "K",
         "C", 
         "H", "S", "T", "N", "Q",
         "D", "E",
         "F", "W", "Y"),
  cls = c("non-polar","non-polar","non-polar","non-polar","non-polar","non-polar","non-polar",
          "+ charged","+ charged",
          "polar",
          "polar","polar","polar", "polar","polar",
          "- charged","- charged",
          "aromatic", "aromatic","aromatic"))

p1a <- contacts.a.s %>%
  filter(type == 'cdrpa') %>%
  ggplot(aes(x = factor(residue.aa.from, levels = aa.levels), 
             y = factor(residue.aa.to, levels = aa.levels), fill = E12)) +
  geom_tile() +
  scale_fill_distiller("TCRen", palette = "RdBu", limits = c(-2.2, 2.2), direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(legend.position = "bottom", aspect = 1,
        legend.key.width = unit(1,"cm"),
        legend.key.height = unit(.3, "cm")) 

p1b <- contacts.a.s %>%
  filter(type == 'cdrpa') %>%
  ggplot(aes(x = factor(residue.aa.from, levels = aa.levels), 
             y = 1, fill = E1)) +
  geom_tile() +
  scale_fill_distiller("Mean odds", palette = "RdBu", limits = c(-0.3, 0.3), direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        legend.position = "bottom", 
        legend.key.width = unit(1,"cm"),
        legend.key.height = unit(.3, "cm"),
        aspect.ratio = .05)  

p1c <- contacts.a.s %>%
  filter(type == 'cdrpa') %>%
  select(type, residue.aa.from, residue.aa.to, E12) %>%
  group_by(type) %>%
  spread(residue.aa.from, value = "E12") %>%
  nest() %>%
  mutate(pca = map(data, ~ prcomp(.x %>% column_to_rownames("residue.aa.to"), center = T, scale = T))) %>%
  mutate(pca_aug = map2(pca, data, ~augment(.x, data = .y %>% column_to_rownames("residue.aa.to")))) %>%
  unnest(pca_aug) %>%
  mutate(aa = .rownames) %>%
  merge(aa.classes) %>%
  ggplot(aes(x = .fittedPC1,
             y = .fittedPC2,
             label = aa,
             color = factor(cls, levels = c("non-polar", "aromatic", "+ charged", "- charged", "polar", "cysteine")))) +
  geom_text() +
  #facet_wrap(~type) +
  scale_color_manual("Amino acid class", values = c("darkgreen", "brown", "blue", "red", "magenta", "yellow")) +
  theme_minimal() +
  theme(legend.position = "bottom", aspect = 1) +
  guides(color=guide_legend(nrow=2,byrow=F)) +
  labs(x="PC1", y="PC2") 

```

```{r Vadim, fig.height=6, fig.width=10}
library(cowplot)
ggdraw() +
  draw_plot(p1a, x = 0, y = 0, width = .6, height = 1) +
  draw_plot(p1b, x = .6, y = .7, width = .4, height = .3) +
  draw_plot(p1c, x = .6, y = 0, width = .35, height = .7) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(0, .58, .58), y = c(1, 1, .7))

```


### Testing energy on real & shuffled complexes

Select Human MHCI

```{r}
general.filtered <- general %>% 
  filter(complex.species == "Human") %>%
  group_by(pdb.id) %>%
  mutate(is.class1 = any(chain.supertype == "MHCI")) %>%
  filter(is.class1) %>%
  select(-is.class1)
```

CDR3 residues and length (from)

```{r}
resides.from <- resmarkup %>%
  merge(general.filtered) %>%
  filter(startsWith(region.type, "CDR3")) %>%
  mutate(pdb.id.from = pdb.id,
         chain.type.from = chain.type,
         region.type.from = region.type,
         residue.index.from = residue.index,
         residue.aa.from = residue.aa) %>%
  group_by(pdb.id.from, chain.type.from, region.type.from) %>%
  mutate(pos.from = residue.index.from - min(residue.index.from),
         len.from = max(pos.from) + 1) %>%
  select(pdb.id.from, chain.type.from, region.type.from, residue.index.from, 
         pos.from, len.from, residue.aa.from) %>%
  ungroup %>%
  arrange(pdb.id.from, chain.type.from, residue.index.from)
```

Peptide residues and length (from)

```{r}
resides.to <- resmarkup %>%
  merge(general.filtered) %>%
  filter(region.type == "PEPTIDE") %>%
  mutate(pdb.id.to = pdb.id,
         chain.type.to = chain.type,
         region.type.to = region.type,
         residue.index.to = residue.index,
         residue.aa.to = residue.aa) %>%
  group_by(pdb.id.to, chain.type.to, region.type.to) %>%
  mutate(pos.to = residue.index.to - min(residue.index.to),
         len.to = max(pos.to) + 1) %>%
  select(pdb.id.to, chain.type.to, region.type.to, residue.index.to, 
         pos.to, len.to, residue.aa.to) %>%
  ungroup %>%
  arrange(pdb.id.to, chain.type.to, residue.index.to)
```

Select PDB ids for combinations with CDR3 and peptide lengths matching real ones for both CDR3 and peptide

```{r}
comb.sel <- merge(
  resides.from %>%
    mutate(pdb.id = pdb.id.from,
           cdr3.len = len.from) %>%
    select(pdb.id, chain.type.from, cdr3.len) %>%
    unique,
  resides.to %>%
    mutate(pdb.id = pdb.id.to,
           pep.len = len.to) %>%
    select(pdb.id, pep.len) %>%
    unique
)

comb.sel <- merge(
  comb.sel %>%
    select(pdb.id.from = pdb.id,
           chain.type.from,
           cdr3.len.from = cdr3.len,
           pep.len.from = pep.len),
  comb.sel %>%
    select(pdb.id.to = pdb.id,
           chain.type.from,
           cdr3.len.to = cdr3.len,
           pep.len.to = pep.len)
) %>%
  filter(cdr3.len.from == cdr3.len.to,
         pep.len.from == pep.len.to) %>%
  mutate(real = pdb.id.from == pdb.id.to) %>%
  select(-cdr3.len.from, -cdr3.len.to, -pep.len.from, -pep.len.to)
```

All combinations of PDB pairs with same CDR3 and peptide length

```{r}
resides.comb <- comb.sel %>%
  merge(resides.from) %>%
  merge(resides.to)
```

Get contacts for real complexes

```{r}
contacts.real <- resides.comb %>%
  filter(real) %>%
  merge(contacts.a %>%
          filter(region.type.from == "CDR3", chain.type.to == "PEPTIDE") %>%
          mutate(pdb.id.from = pdb.id, chain.type.from, contact = 1) %>%
          #mutate(contact = 1) %>%
          select(pdb.id.from, chain.type.from, residue.index.from, residue.index.to, contact),
        all.x = T) %>%
  mutate(contact = ifelse(is.na(contact), 0, contact))
```

Append information on contacts. For mock complexes we either use contacts from TCR or peptide side ('perspective')

```{r}
contacts.all <- rbind(
  resides.comb %>%
    merge(contacts.real %>%
            mutate(perspective = "cdr") %>%
            select(perspective, pdb.id.from, chain.type.from, pos.from, pos.to, contact)),
  resides.comb %>%
    merge(contacts.real %>%
            mutate(perspective = "pep") %>%
            select(perspective, pdb.id.to, chain.type.from, pos.from, pos.to, contact))
)
```

Append energy information

```{r}
contacts.all.e <- contacts.all %>%
  # from - cdr, to - peptide
  # pos - zero based
  #id pos.from pos.to residue.aa.from residue.aa.to contact
  merge(contacts.a.s %>%
          filter(type == "cdrpa") %>%
          select(residue.aa.from, residue.aa.to, odds, E12, E1, E2)) # somewhat less due to 'X'
```

Simple odds summary

```{r}
contacts.all.e.s1 <- contacts.all.e %>%
  group_by(real, pdb.id.from, pdb.id.to, chain.type.from, perspective) %>% # group by id, chain
  summarize(odds.s = sum(odds * contact),
            e12.s = sum(E12 * contact),
            e1.s = sum((pos.to == 0) * E1),
            e1tr.s = sum((pos.to == 0 & pos.from > 3 & pos.from < len.from - 4) * E1),
            e2.s = sum((pos.from == 0) * E2))
```

```{r}
contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = -odds.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1tr.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)
```

```{r}
contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = -odds.s - e1tr.s - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1tr.s - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)
```


```{r}
contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = real, x = etot)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_wrap(~perspective)

contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(odds.s = sum(odds.s)) %>%
  ggplot(aes(color = real, x = fct_reorder(pdb.id.from, odds.s) %>% as.integer, y = odds.s)) +
  geom_smooth() +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  geom_point() +
  facet_wrap(~perspective)

contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = real, x = fct_reorder(pdb.id.from, etot) %>% as.integer, y = etot)) +
  geom_smooth() +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  geom_point() +
  facet_wrap(~perspective)
```
```{r}
p2a <- contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  mutate(perspective = ifelse(perspective == "pep", "Peptide perspective", "TCR perspective"),
                              type = ifelse(real == "TRUE", "Real", "Shuffled")) %>%
  group_by(perspective, type, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = type, x = etot)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_wrap(~perspective) +
  theme_bw() +
  labs(color = "Type of complexes", x = 'Etot', y = 'CDF') +
  scale_colour_manual(values = c("red", "cyan4")) +
  theme(legend.position = 'bottom',
        text=element_text(size=15))

p2a
```

###Vadim's code


Create MJ.a dataframe for MJ, MJ2 and TCRen comparision
```{r}
#matrix for MJ potential were taken from BioPhysConnectoR package, mj1 - matrix for intrachain interactions between amino acids [Miyazawa and Jernigan(1996)], mj2 - matrix for interchain interactions between amino acids [Keskin et al. (1998)] 
aa.mj <- c("C","M","F","I","L","V","W","Y","A","G","T","S","N","Q","D","E","H","R","K","P")
MJ <- read.table("./mj1.txt")
colnames(MJ) <- aa.mj
rownames(MJ) <- aa.mj
MJ.interchain <- read.table("./mj2.txt")
colnames(MJ.interchain) <- aa.mj
rownames(MJ.interchain) <- aa.mj

MJ.a <- MJ %>%
  rownames_to_column("residue.aa.from") %>%
  as.data.table() %>%
  melt(id = 1, variable.name = "residue.aa.to", value.name = "MJ") %>%
  merge(MJ.interchain %>%
          rownames_to_column("residue.aa.from") %>%
          as.data.table() %>%
          melt(id = 1, variable.name = "residue.aa.to", value.name = "MJ.interchain")) %>%
  mutate(MJ = -MJ,
         MJ.interchain = -MJ.interchain)
  
MJ.a <- MJ.a %>%
  merge(contacts.a.s %>%
          filter(type == "cdrpa") %>% 
          select(residue.aa.to, residue.aa.from, E12)) 
```

```{r Vadim, Suppl Fig 1, fig.width=8, fig.height=8, warning=FALSE}
ps1a <- MJ.a %>%
  ggplot(aes(x = factor(residue.aa.from, levels = aa.levels), 
             y = factor(residue.aa.to, levels = aa.levels), fill = MJ)) +
  geom_tile() +
  scale_fill_distiller("", palette = "RdBu", direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(legend.position = "bottom", aspect = 1,
        legend.key.width = unit(1,"cm"),
        legend.key.height = unit(.3, "cm")) +
  ggtitle("MJ potential") + theme(plot.title = element_text(hjust = 0.5))

ps1b <- MJ.a %>%
  ggplot(aes(x = factor(residue.aa.from, levels = aa.levels), 
             y = factor(residue.aa.to, levels = aa.levels), fill = MJ.interchain)) +
  geom_tile() +
  scale_fill_distiller("", palette = "RdBu", direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(legend.position = "bottom", aspect = 1,
        legend.key.width = unit(1,"cm"),
        legend.key.height = unit(.3, "cm")) +
  ggtitle("MJ interchain potential") + theme(plot.title = element_text(hjust = 0.5))

ps1c <- MJ.a %>%
  group_by(residue.aa.from) %>%
  summarise(MJ.mean = mean(MJ),
            MJ.interchain.mean = mean(MJ.interchain)) %>%
  as.data.table() %>%
  melt(variable.name = "Potential") %>%
  ggplot(aes(x = factor(residue.aa.from, levels = aa.levels), y = value, 
             color = Potential, group = Potential)) +
  geom_point() + geom_line() +
  theme_minimal() +
  scale_color_manual("Mean value of potential", values = c("blue", "purple"), labels = c("MJ", "MJ interchain")) +
  xlab("") + ylab("") +
  theme(legend.position = "bottom")

ggdraw() +
  draw_plot(ps1a, x = 0, y = .45, width = .5, height = .55) +
  draw_plot(ps1b, x = .5, y = .45, width = .5, height = .55) +
  draw_plot(ps1c, x = .2, y = 0, width = .6, height = .4) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(0, .5, .19), y = c(1, 1, .4))
```

```{r}
contacts.all.e.MJ <- contacts.all.e %>%
  merge(MJ.a %>%
          select(residue.aa.from, residue.aa.to, MJ, MJ.interchain))

contacts.all.e.s1.MJ <- contacts.all.e.MJ %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(odds.s = sum(odds * contact),
            e12.s = sum(E12 * contact),
            e1.s = sum((pos.to == 0) * E1),
            e1tr.s = sum((pos.to == 0 & pos.from > 3 & pos.from < len.from - 4) * E1),
            e2.s = sum((pos.from == 0) * E2),
            etot = sum(e12.s  - e1tr.s - e2.s),
            MJ.s = sum(MJ * contact),
            MJ.interchain.s = sum(MJ.interchain * contact))
```


```{r}
library(plotROC)

p2b <- contacts.all.e.s1 %>%
  group_by(pdb.id.from, pdb.id.to, real, perspective, chain.type.from) %>%
  summarise(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  rbind(contacts.all.e.s1 %>%
          group_by(pdb.id.from, pdb.id.to, real, perspective) %>%
          summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
          mutate(chain.type.from = 'TRA + TRB')) %>%
  ggplot(aes(d = real, m = -etot, color = factor(chain.type.from, levels = c('TRA + TRB', 'TRA', 'TRB')))) + 
  geom_vline(xintercept = 1, size = 1) +
  geom_abline(intercept = 1, slope = 0, size = 1) +
  geom_roc(n.cuts = 0) + 
  style_roc(major.breaks = c(0, 0.25, 0.5, 0.75, 1), minor.breaks = F, theme = theme_classic) + 
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  labs(color = "Chain", x = 'False positive rate', y = 'True positive rate') +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual(values=c('red', 'gray50', 'black')) +
  theme(legend.position = c(.75,.2),
        legend.box.background = element_rect(colour = "black"),
        aspect = 1,
        text=element_text(size=15))

#basicplot <- ggplot(contacts.a.e.s2, aes(d = real, m = -etot, color = #factor(chain.type.from, levels = c('TRA + TRB', 'TRA', 'TRB')))) + geom_roc()
#AUC = round(calc_auc(basicplot)$AUC, 2)

p2c <- contacts.all.e.s1.MJ %>%
  select(pdb.id.from, pdb.id.to, perspective, real, TCRen = etot, MJ.s, MJ.interchain.s) %>%
  filter(MJ.s != 0) %>%
  as.data.table() %>%
  melt(id = c(1:4), variable.name = "potential") %>%
  ggplot(aes(d = real, m = -value, color = potential)) + 
  geom_vline(xintercept = 1, size = 1) +
  geom_abline(intercept = 1, slope = 0, size = 1) +
  geom_roc(n.cuts = 0) + 
  style_roc(major.breaks = c(0, 0.25, 0.5, 0.75, 1), minor.breaks = F, theme = theme_classic) + 
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  labs(x = 'False positive rate', y = 'True positive rate') +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0)) +
  scale_color_manual("Potential", values=c('red', 'blue', 'purple'), 
                     labels = c("TCRen", "MJ", "MJ interchain")) +
  theme(legend.position = c(.75,.2),
        legend.box.background = element_rect(colour = "black"),
        aspect = 1,
        text=element_text(size=15))
```

```{r, fig.width=10, fig.height=10, warning=FALSE}
library(plyr)
ggdraw() +
  draw_plot(p2a, x = .15, y = .6, width = .75, height = .4) +
  draw_plot(p2b, x = 0, y = 0, width = .45, height = .6) +
  draw_plot(p2c, x = .5, y = 0, width = .45, height = .6) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(.15, 0, .5), y = c(1, .55, .55))
```
```{r}
#Vadim

peptides.DMF5 <- read.table("peptides_DMF5.txt", header = 1) 

peptides.DMF5.a <- peptides.DMF5 %>%
  separate(peptide, into = paste0("", 0:9), sep = 1:10, remove = F) %>%
  as.data.table() %>%
  melt(id = c(1:2), variable.name = "pos.to", value.name = "residue.aa.to") 

contacts_pdb <- function(pdb) {
  contacts.all %>%
          filter(pdb.id.from == pdb, real, perspective == 'pep')
}

contacts.DMF5 <- peptides.DMF5.a %>%
  merge(contacts_pdb("6am5_al2.pdb") %>% 
          select(-real, -residue.aa.to)) %>%
  rbind(peptides.DMF5.a %>%
          merge(contacts_pdb("3qdg_al2.pdb") %>%
                  select(-real, -residue.aa.to))) %>%
  rbind(peptides.DMF5.a %>%
          merge(contacts_pdb("6amu_al2.pdb") %>%
                  select(-real, -residue.aa.to))) 
                  
contacts.DMF5.e.s1 <- contacts.DMF5 %>%
  merge(contacts.a.s %>%
          filter(type == "cdrpa") %>%
          select(residue.aa.from, residue.aa.to, odds, E12, E1, E2)) %>%
  merge(MJ.a %>%
          select(residue.aa.from, residue.aa.to, MJ, MJ.interchain)) %>%
  group_by(pdb.id.from,  motif, peptide) %>%    #pdb.id.to, chain.type.from, perspective
  summarize(odds.s = sum(odds * contact),
            e12.s = sum(E12 * contact),
            e1tr.s = sum((pos.to == 0 & pos.from > 3 & pos.from < len.from - 4) * E1),
            e2.s = sum((pos.from == 0) * E2),
            etot = sum(e12.s  - e1tr.s - e2.s),
            MJ.s = sum(MJ * contact),
            MJ.interchain.s = sum(MJ.interchain * contact))            

contacts.DMF5.e.s1 <- contacts.DMF5.e.s1 %>%
  mutate(template = substring(pdb.id.from, 1, 4)) %>%
  select(template, motif, peptide, etot, MJ.s, MJ.interchain.s) %>%
  merge(read_csv("DMF5_dG_rosetta.csv"), all.x = T) %>%
  mutate(#real = ifelse(template == "6am5" & peptide == "SMLGIGIVPV" | 
        #                 template == "3qdg" & peptide == "ELAGIGILTV" |
        #                 template == "6amu" & peptide == "MMWDRGLGMM",
        #               T, F),
         motif = ifelse(motif == "no_motif", "no motif", motif))

contacts.DMF5.e.s1 <- contacts.DMF5.e.s1 %>%
  select(template, motif, peptide, TCRen = etot, MJ = MJ.s, MJ.interchain = MJ.interchain.s, dG.rosetta) %>%
  melt(id = c("template", "motif", "peptide"), 
       variable.name = "potential") %>%
  filter(!(potential != "dG.rosetta" & template == "6am5"),
         !(potential == "dG.rosetta" & template == "3qdg")) %>%
  mutate(template = ifelse(template == "6amu", "DRG template", "GIG template"),
         template = factor(template, levels = c("GIG template", "DRG template")),
         motif = factor(motif, levels = c("GIG", "DRG", "no motif")),
         real = ifelse(template == "GIG template" & motif == "GIG" | 
                         template == "DRG template" & motif == "DRG",
                       T, F),)

plot_DMF5 <- function(.pot, text) {  
  stat.test <- contacts.DMF5.e.s1 %>%
    filter(potential == .pot) %>%
    group_by(template) %>%
    wilcox_test(value ~ motif) %>%
    adjust_pvalue(method = "bonferroni") %>%
    add_significance()
  stat.test <- stat.test %>% add_y_position()
  contacts.DMF5.e.s1 %>%
    filter(potential == .pot) %>%
    ggplot(aes(x = motif, y = value)) +
    facet_wrap(~ template) +
    #geom_jitter(aes(fill = real), width = .1, shape = 21, size = 2) +
    geom_quasirandom(aes(fill = real), width = .2, shape = 21, size = 2) +
    stat_summary(fun.y="median", geom='point', shape = 95, size = 15, color = 'red') +
    ylab(text) + xlab("") +
    theme_bw() +
    theme(legend.position = "none",
          text=element_text(size=15)) +
    scale_fill_manual(values = c("darkgrey", "chartreuse3")) +
    #scale_fill_brewer() +
    stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01) +
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.1)))
}

p3a <- plot_DMF5("TCRen", "TCRen potential")
p3b <- plot_DMF5("MJ", "MJ potential")
p3c <- plot_DMF5("dG.rosetta", "Rosetta dG for MD trajectories")
#plot_DMF5("MJ.interchain", "MJ interchain potential")

```

```{r, fig.width=10, fig.height=8}
ggdraw() +
  draw_plot(p3a, x = .25, y = .5, width = .5, height = .5) +
  draw_plot(p3b, x = 0, y = 0, width = .45, height = .5) +
  draw_plot(p3c, x = .5, y = 0, width = .45, height = .5) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(.25, 0, .5), y = c(1, .5, .5))
```

```{r}
p3c + theme(text=element_text(size=16))
```



```{r}
library(ggExtra)

p4a <- ggMarginal(ggplot(MJ.a, aes(x=MJ, y=E12)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  labs(y= "TCRen", x = "Miyazawa-Jernigan potential") + 
  theme_bw()+
  theme(text=element_text(size=15)), type="histogram") 

```

```{r}
#Amino acid frequencies for general protein-protein interfaces were taken from Glaser et al., 2001 
#Amino acids frequencies for CDR3's in TCR repertoire were calculated using data from Emerson et al., 2017

aa.freq.interface <- tibble(type = c(rep("General protein-protein\n interfaces", 20), rep("CDR3 in TCR repertoire", 20)),
                  aminoacid = rep(c("R","K","N","D","Q","E","H","P","Y","W","S","T","G","A","M","C","F","L","V","I"), 2),
                  freq = c(c(6, 5.3, 4.5, 5.6, 4.4, 6.2, 2.5, 4.7, 4.6, 1.8, 6.2, 6, 6.6, 6.5, 2.2, 1.8, 4.2, 8.2, 6, 5),
                           c(6.5, 1.1, 6.4, 5.4, 5.5, 4.4, 0.9, 4.9, 5.6, 1.0, 8.9, 8.3, 20.9, 6.1, 0.6, 0.0, 1.7, 6.7, 3.6, 1.4))) %>% 
  mutate(freq = freq / 100)

p4b <- aa.freq.interface %>% 
  ggplot(aes(x = factor(aminoacid, levels = aa.levels), y = freq, color = type, group = type)) +
  geom_line() +
  scale_color_manual("", values = c("red", "blue")) +
  xlab("") + ylab("Amino acid frequency") + theme_minimal() + 
  theme(legend.position = c(0.8, 0.8),
        legend.background = element_rect(colour = "white"),
        text=element_text(size=15))

```




```{r}
aa.classes.2 <- tibble (  
  aa = c("A","I","L","V","M","G","P",
         "R","K",
         "C","H","S","T","N","Q",
         "D","E",
         "F","W","Y"),
  cls = c("nonpolar","nonpolar","nonpolar","nonpolar","nonpolar","nonpolar","nonpolar",
          "+ charged","+ charged",
          "polar","polar","polar","polar", "polar","polar",
          "- charged","- charged",
          "nonpolar","nonpolar","polar"))

class.levels <- c("nonpolar & nonpolar", "nonpolar & polar","charged & nonpolar","polar & polar","charged & polar", "charged & charged")

MJ.a.class <- MJ.a %>%
  filter(as.character(residue.aa.from) <= as.character(residue.aa.to)) %>%
  as.data.table() %>%
  melt(id = c(1:2), variable.name = "Potential") %>%
  group_by(Potential) %>%
  mutate(value.min = min(value),
         value.max = max(value),
         value.norm = (value - value.min) / (value.max - value.min)) %>%
  merge(aa.classes.2 %>% select(residue.aa.to = aa, class.to = cls)) %>%
  merge(aa.classes.2 %>% select(residue.aa.from = aa, class.from = cls)) 

p4c <- MJ.a.class %>%
  mutate(class.to = ifelse(endsWith(class.to, "charged"), "charged", class.to),
         class.from = ifelse(endsWith(class.from, "charged"), "charged", class.from)) %>%
  rowwise() %>%
  mutate(class = paste(min(class.to, class.from), max(class.to, class.from), sep = " & ")) %>% 
  filter(Potential %in% c("MJ", "E12")) %>%
  ggplot(aes(x = factor(class, levels = class.levels), y = value.norm, fill = Potential)) + 
  geom_boxplot(outlier.shape=NA) +
  geom_quasirandom(size = .4, position = position_jitterdodge(jitter.width = .1),  dodge.width = 0.75) +
  scale_fill_manual(values = c("blue", "red"), labels = c("MJ", "TCRen")) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust = 1),
        text=element_text(size=15)) +
  labs(x = '', y = 'Normalized value') 

p4d <- MJ.a.class %>%
  filter(endsWith(class.to, "charged") & endsWith(class.from, "charged")) %>%
  rowwise() %>%
  mutate(class = paste(min(class.to, class.from), max(class.to, class.from), sep = " & ")) %>% 
  filter(Potential %in% c("MJ", "E12")) %>%
  ggplot(aes(x = class, y = value.norm, fill = Potential, group = Potential)) + 
  geom_quasirandom(position = position_jitterdodge(jitter.width = .2), shape = 21, size = 3, dodge.width = 0.75) +
  scale_fill_manual(values = c("blue", "red"), labels = c("MJ", "TCRen")) + 
  stat_summary(fun.y='median', geom='crossbar', 
               mapping=aes(ymin=..y.., ymax=..y..), 
               width=0.3, lwd=0.3, position = position_dodge(width = 0.7), 
               color="black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust = 1),
        text=element_text(size=15),
        aspect = 1,
        legend.position = "none") +
  labs(x = '', y = 'Normalized value') +
  ylim(0, 1)

```

```{r, fig.width=12, fig.height=9, warning=FALSE}
ggdraw() +
  draw_plot(p4a, x = 0, y = .65, width = .5, height = .35) +
  draw_plot(p4b, x = .5, y = .65, width = .5, height = .35) +
  draw_plot(p4c, x = 0, y = 0, width = .7, height = .6) +
  draw_plot(p4d, x = .7, y = 0, width = .3, height = .6) +
  draw_plot_label(label = c("A", "B", "C", "D"), size = 15,
                  x = c(.0, .47, 0, .655), y = c(1, 1, .63, .63))
```

```{r, fig.width=12, fig.height=9, warning=FALSE}
ps4a <- ggMarginal(ggplot(MJ.a, aes(x=MJ, y=E12)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  labs(y= "TCRen", x = "Miyazawa-Jernigan interchain potential") + 
  theme_bw() +
  theme(text=element_text(size=15)), type="histogram")

ps4b <- MJ.a.class %>%
  mutate(class.to = ifelse(endsWith(class.to, "charged"), "charged", class.to),
         class.from = ifelse(endsWith(class.from, "charged"), "charged", class.from)) %>%
  rowwise() %>%
  mutate(class = paste(min(class.to, class.from), max(class.to, class.from), sep = " & ")) %>% 
  filter(Potential %in% c("MJ.interchain", "E12")) %>%
  ggplot(aes(x = factor(class, levels = class.levels), y = value.norm, fill = Potential)) + 
  geom_boxplot(outlier.shape=NA) +
  geom_quasirandom(size = .4, position = position_jitterdodge(jitter.width = .1), dodge.width = 0.75) +
  scale_fill_manual(values = c("purple", "red"), labels = c("MJ interchain", "TCRen")) + 
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust = 1),
        text=element_text(size=15)) +
  labs(x = '', y = 'Normalized value') 

ps4c <- MJ.a.class %>%
  filter(endsWith(class.to, "charged") & endsWith(class.from, "charged")) %>%
  rowwise() %>%
  mutate(class = paste(min(class.to, class.from), max(class.to, class.from), sep = " & ")) %>% 
  filter(Potential %in% c("MJ.interchain", "E12")) %>%
  ggplot(aes(x = class, y = value.norm, fill = Potential, group = Potential)) + 
  geom_quasirandom(position = position_jitterdodge(jitter.width = .2), shape = 21, size = 3, dodge.width = 0.75) +
  scale_fill_manual(values = c("purple", "red"), labels = c("MJ interchain", "TCRen")) + 
  stat_summary(fun.y='median', geom='crossbar', 
               mapping=aes(ymin=..y.., ymax=..y..), 
               width=0.3, lwd=0.3, position = position_dodge(width = 0.7), 
               color="black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=60, hjust = 1),
        text=element_text(size=15),
        aspect = 1,
        legend.position = "none") +
  labs(x = '', y = 'Normalized value') +
  ylim(0, 1)

ggdraw() +
  draw_plot(ps4a, x = .25, y = .65, width = .5, height = .35) +
  draw_plot(ps4b, x = 0, y = 0, width = .6, height = .6) +
  draw_plot(ps4c, x = .6, y = 0, width = .4, height = .6) +
  draw_plot_label(label = c("A", "B", "C"), size = 15,
                  x = c(.25, 0, .55), y = c(1, .63, .63))

```




```{r}
library(Peptides)
descriptors <- aaDescriptors(aas) %>%
  as.data.frame() %>%
  mutate(residue.aa.from = aas, residue.aa.to = aas) 

descriptors.a <- MJ.a %>%
  select(residue.aa.from, residue.aa.to, MJ, MJ.interchain, E12) %>%
  merge(descriptors %>% select(-residue.aa.to)) %>%
  merge(descriptors %>% select(-residue.aa.from) %>%
          rename_all(funs(str_replace(., "\\.1", "\\.2"))))
   

levels.kf <- c("linear term", paste0("KF", 1:10, ".1"), paste0("KF", 1:10, ".2"))
levels.blosum <- c("linear term", paste0("BLOSUM", 1:10, ".1"), paste0("BLOSUM", 1:10, ".2"))

KF <- descriptors.a %>%
  select(starts_with("KF")) %>% 
  model.matrix( ~.^2, data = .)

KF.cor <- cor(descriptors.a$MJ, KF) %>%
  rbind(cor(descriptors.a$MJ.interchain, KF)) %>%
  rbind(cor(descriptors.a$E12, KF)) %>%
  t() %>%
  magrittr::set_colnames(c("MJ", "MJ.interchain", "TCRen")) %>%
  cbind(term = rownames(.)) %>%
  as.tibble() %>%
  filter(term != '(Intercept)') %>%
  separate("term", into = c("term.1", "term.2"), sep = ":") %>%
  replace(is.na(.), "linear term") %>%
  as.data.table() %>%
  melt(id = c("term.1","term.2"), variable.name = "Potential")

BLOSUM <- descriptors.a %>%
  select(starts_with("BLOSUM")) %>% 
  model.matrix( ~.^2, data = .)

BLOSUM.cor <- cor(descriptors.a$MJ, BLOSUM) %>%
  rbind(cor(descriptors.a$MJ.interchain, BLOSUM)) %>%
  rbind(cor(descriptors.a$E12, BLOSUM)) %>%
  t() %>%
  magrittr::set_colnames(c("MJ", "MJ.interchain", "TCRen")) %>%
  cbind(term = rownames(.)) %>%
  as.tibble() %>%
  filter(term != '(Intercept)') %>%
  separate("term", into = c("term.1", "term.2"), sep = ":") %>%
  replace(is.na(.), "linear term") %>%
  as.data.table() %>%
  melt(id = c("term.1","term.2"), variable.name = "Potential")


plot_cor <- function(df, potential, levels, text) {
  #.limit <- apply(df, 2, function(x) max(abs(as.numeric(x))))[potential]
  .limit <- max(abs(as.numeric(unlist(df[df$Potential == potential, "value"]))))
  df %>%
  filter(Potential == potential) %>%
  ggplot(aes(x = factor(term.2, levels = levels), y = factor(term.1, levels = levels),  fill = as.double(value))) +
  geom_tile(aes(width=1, height=1)) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(aspect = 1,
        axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        legend.position = "bottom",
        legend.key.width = unit(.6,"cm"),
        legend.key.height = unit(.3, "cm")) +
  scale_fill_distiller("cor with cross-term", palette = "RdBu", 
                       limits = c(-1,1)*.limit) +
  ggtitle(text) 
}

p5a <- plot_cor(KF.cor, "TCRen", levels.kf, "TCRen")
p5b <- plot_cor(KF.cor, "MJ", levels.kf, "MJ")

ps5a <- plot_cor(BLOSUM.cor, "TCRen", levels.blosum, "TCRen")
ps5b <- plot_cor(BLOSUM.cor, "MJ", levels.blosum, "MJ")

p5a
p5b
ps5a
ps5b
```
```{r Fig S5, fig.height=5, fig.width=10}
ggdraw() +
  draw_plot(ps5a, x = 0, y = 0, width = .5, height = 1) +
  draw_plot(ps5b, x = .5, y = 0, width = .5, height = 1) +
  draw_plot_label(label = c("A", "B"), size = 11,
                  x = c(0.03, .53), y = c(1, 1))
```


MJ matrix eigenvectors' correlation with KF
```{r}
library(corrplot)
library(bio3d)
library(latex2exp)

eigen.mj <- sweep(MJ, 2, mean(apply(MJ, 2, mean))) %>%
  eigen()

ps6a <- ggplot(data.frame(eigen.mj$values),
       aes(x = seq_along(eigen.mj$values), y = eigen.mj$values)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  scale_x_reverse() +
  #ggtitle("MJ matrix eigenvalues") +
  xlab(TeX("$\\alpha$ (eigenvector)")) +
  ylab(TeX("$\\lambda_{\\alpha}$ (eigenvalue)")) +
  theme_minimal()

#corrplot(cor(eigen.mj$vectors), type = 'upper', title = "MJ.norm eigenvalues correlation", mar=c(0,0,2,0))

png(file = "~/struct2020/figS6b.png")
corrplot(cor(eigen.mj$vectors, aaDescriptors(colnames(MJ))) %>% as.data.frame() %>%
               select(starts_with("KF")) %>% as.matrix(), 
         tl.cex=1, #title = "MJ eigenvectors correlation with KF",  
         mar=c(0,0,2,0))
dev.off()
```
```{r}
ggdraw() +
  draw_plot(ps6a, x = 0, y = 0, width = .5, height = .95) +
  draw_image("~/struct2020/figS6b.png", x = .4, y = .12, width = .6, height = .91) +
  draw_plot_label(label = c("A", "B"), size = 10,
                  x = c(0.02, .52), y = c(1, 1))

```


TCRen matrix eigenvectors' correlation with KF
```{r}
tcren <- MJ.a %>%
  as.data.table() %>%
  dcast(as.character(residue.aa.from) ~ as.character(residue.aa.to), value.var = "E12") %>%
  column_to_rownames("residue.aa.from")

eigen.tcren <- sweep(tcren, 2, mean(apply(tcren, 2, mean))) %>%
  eigen()

p5d <- ggplot(data.frame(eigen.tcren$values),aes(seq_along(eigen.tcren$values),eigen.tcren$values)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  scale_x_reverse() +
  #ggtitle("tcren.norm matrix eigenvalues") +
  xlab(TeX("$\\alpha$ (eigenvector)")) +
  ylab(TeX("$\\lambda_{\\alpha}$ (eigenvalue)")) +
  theme_minimal() 

corrplot(cor(eigen.tcren$vectors), type = 'upper', title = "TCRen eigenvalues correlation", mar=c(0,0,2,0))


eigen.tcren.cor <- cor(eigen.tcren$vectors, aaDescriptors(colnames(tcren))) %>%
  as.data.frame() %>%
  select(starts_with("KF")) %>% 
  set_names(str_split_fixed(colnames(.), "\\.", 2)[,1]) %>%
  as.matrix() 

#png(height=1800, width=1800, file="fig5c.png", type = "cairo")
#pdf(file = "fig5c.pdf")
png(file = "~/struct2020/fig5c.png")
corrplot(eigen.tcren.cor, 
         tl.cex=1, #title = "MJ eigenvectors correlation with KF",  
         mar=c(0,0,2,0))
dev.off()
#while (!is.null(dev.list()))  dev.off()

```

Kidera factors properties explanation
```{r}
p5c <- tibble(KF = paste0("KF", c(1:10)), Property = c("Helix/bend preference", "Side-chain size", "Extended structure preference", "Hydrophobicity", "Double-bend preference", "Partial specific volume", "Flat extended preference", "Occurrence in alpha region", "pK-C", "Surrounding hydrophobicity")) %>% 
  ggtexttable(rows = NULL,
                  theme = ttheme("classic", base_size = 11))
```


```{r}
library(bio3d)
data("aa.index")
aa.2 <- c('A','R','N','D','C','Q','E','G','H','I','L','K','M','F','P','S','T','W','Y','V')
aa.index.2 <- do.call(rbind, aa.index)
aa.indices <- data.frame(matrix(ncol=544,nrow=20, dimnames=list(aa.2, aa.index.2[545:1088])))
for (i in 1:544){
  aa.indices[,i] <- aa.index.2[3808 + i]
}

top <- 10

aa.indices.a <- aa.indices[colnames(tcren),]

eigen.tcren.vectors.cor.i <- cor(eigen.tcren$vectors, aa.indices.a)

p5d <- eigen.tcren.vectors.cor.i %>%
  as.data.frame() %>%
  mutate(eigenvector = as.numeric(rownames(.)),
         eigenvalue = round(eigen.tcren$values, 2)) %>%
  #rownames_to_column("eigenvector") %>%
  as.data.table() %>%
  melt(id = c("eigenvector", "eigenvalue"), variable.name = "property", value.name = "correlation") %>%
  dplyr::arrange(eigenvector, -abs(correlation)) %>%
  group_by(eigenvector) %>%
  filter(row_number()==1) %>%
  mutate(#eigenvector = as.numeric(eigenvector),
         property = str_split_fixed(property, "\\.\\.", 4)[,1],
         property = str_replace_all(property,"\\."," "),
         correlation = round(correlation, 2))
```

```{r, fig.width=10, fig.height=10}
ggdraw() +
  draw_plot(p5a, x = 0, y = .5, width = .5, height = .5) +
  draw_plot(p5b, x = .5, y = .5, width = .5, height = .5) +  
  draw_plot(p5c, x = -.06, y = .17, width = .5, height = .25) +
  draw_image("~/struct2020/fig5c.png", x = .55, y = 0.05, width = .5, height = .45) +
  draw_plot(p5d, x = .35, y = 0, width = .3, height = .47) +
  #draw_plot(ps4c, x = .6, y = 0, width = .4, height = .6) +
  draw_plot_label(label = c("A", "B", "C", "D", "E"), size = 11,
                  x = c(0.05, .55, 0, .35, .67), y = c(1, 1, .48, .48, .48))

```

