---
title: "Untitled"
output: html_document
---

For its work the script reqiures (in the same folder):
1) mir-1.0-SNAPSHOT.jar
2) PDB(s) structures for in silico peptide screening 
3) list of PDB file names, each in a separate line, no header
4) (optional) df with peptides for peptide screening (1st col: PDB name, 2nd col: peptide)
5) (optional) df with CDR3s for CDR3 screening (1st col: PDB name, 2nd col: chain (TRA or TRB), 3rd col: CDR3 seq)

```{r}
library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
library(magrittr)
#library(ggbeeswarm)
```

```{r}
#fread("~/struct2020/TCRen.csv") %>% 
#  select(residue.aa.from, residue.aa.to, TCRen = TCRen.005) %>% 
#  mutate(TCRen = -TCRen) %>% 
#  fwrite("TCRen.csv")
```

# Input data
```{r}
file_pdb_list <- "pdb_list.txt"
file_mutate_peptides <- "mutate_peptides.csv"
file_mutate_CDR3 <- "mutate_CDR3.csv"

pdb_list <- fread(file_pdb_list, header = F) %>% 
  set_colnames("pdb.id")

peptide_list <- fread(file_mutate_peptides, header = F) %>% 
  set_colnames(c("pdb.id", "peptide"))

CDR3_list <- fread(file_mutate_CDR3, header = F) %>% 
  set_colnames(c("pdb.id", "chain.type.from", "CDR3"))
```

#Annotation of structures and contacts by MIR
```{r}
MEMORY <- "20G"

run_mir <- function(pdb_list,
                     mir_path = "mir-1.0-SNAPSHOT.jar", 
                     output_dir = "mir_output",
                     arg, #"annotate-structures", "compute-pdb-geom", "compute-pdb-contacts"
                     print_log = T) {
  .pdb_list <- pdb_list$pdb.id %>% paste(collapse = " ")
  dir.create(output_dir, showWarnings = FALSE)
  cmd <- str_glue("java -Xmx{MEMORY} -cp {mir_path} com.milaboratory.mir.scripts.Examples {arg} -I {.pdb_list} -O ./{output_dir}/")
  code <- system(cmd,
                 ignore.stdout = !print_log, 
                 ignore.stderr = !print_log)
  if(code != 0) {
    stop(str_glue("Failed to execute '{cmd}'"))
  }
}
system("java -version")
```

```{r}
run_mir(pdb_list = pdb_list, arg = "annotate-structures")
run_mir(pdb_list = pdb_list, arg = "compute-pdb-contacts")
```

# Processing of MIR output
```{r}
contacts <- fread("mir_output/atomdist.txt") %>%
  filter(dist <= 5, chain.id.from != chain.id.to) %>%
  select(-atom.from, -atom.to, -dist) %>%
  unique
  
contacts.a <- rbind(
  contacts,
  contacts %>% 
    rename(chain.id.from = chain.id.to,
           chain.id.to = chain.id.from,
           residue.index.from = residue.index.to,
           residue.index.to = residue.index.from)
)

general_resmarkup <- fread("mir_output/general.txt") %>% 
  merge(fread("mir_output/resmarkup.txt")) %>% 
  group_by(pdb.id, chain.id, region.type) %>% 
  mutate(region.start = min(residue.index)) %>% 
  ungroup 
  

contacts.a.f <- contacts.a %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.from = chain.type, chain.id.from = chain.id,
                 residue.index.from = residue.index, residue.aa.from = residue.aa,
                 region.type.from = region.type, region.start.from = region.start)) %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.to = chain.type, chain.id.to = chain.id, 
                 residue.index.to = residue.index, residue.aa.to = residue.aa,
                 region.type.to = region.type, region.start.to = region.start)) %>% 
  mutate(pos.from = residue.index.from - region.start.from,
         pos.to = residue.index.to - region.start.to) %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  select(pdb.id, chain.type.from, region.type.from, 
         pos.from, pos.to, residue.aa.from, residue.aa.to)
```


# Generate contact maps for mutated complexes

## peptide mutation
```{r}
pep_len_max <- nchar(peptide_list$peptide) %>% max()

contacts.mut.pep <- peptide_list %>% 
  separate(peptide, into = as.character(c(0:(pep_len_max-1))), sep = 1:pep_len_max, remove = F) %>% 
  melt(id = c("pdb.id", "peptide"), variable.name = "pos.to", value.name = "residue.aa.to") %>%
  mutate(pos.to = as.integer(as.character(pos.to))) %>% 
  merge(contacts.a.f %>% 
          select(-residue.aa.to), allow.cartesian=TRUE) %>% 
  mutate(type = "mutated") %>% 
  rbind(contacts.a.f %>% 
          mutate(type = "original") %>% 
          merge(fread("mir_output/markup.txt") %>% 
                  filter(region.type == "PEPTIDE") %>% 
                  select(pdb.id, peptide = region.sequence)))
```

### CDR3 mutation
```{r}
CDR3.orig <- fread("mir_output/markup.txt") %>% 
  merge(general_resmarkup %>% 
          select(pdb.id, chain.id, chain.type) %>% 
          distinct()) %>% 
  filter(region.type == "CDR3") %>% 
  select(pdb.id, chain.type.from = chain.type, CDR3 = region.sequence)

CDR3_len_max <- nchar(CDR3_list$CDR3) %>% max()

contacts.mut.CDR3 <- CDR3_list %>% 
  merge(CDR3.orig %>% rename(CDR3.orig = CDR3), allow.cartesian=TRUE) %>% 
  filter(nchar(CDR3) == nchar(CDR3.orig)) %>% 
  separate(CDR3, into = as.character(c(0:(CDR3_len_max-1))), sep = 1:CDR3_len_max, remove = F) %>% 
  melt(id = c("pdb.id", "chain.type.from", "CDR3"), variable.name = "pos.from", value.name = "residue.aa.from") %>% 
  mutate(pos.from = as.integer(as.character(pos.from)),
         region.type.from = "CDR3") %>% 
  merge(contacts.a.f %>% 
          select(-residue.aa.from), allow.cartesian=TRUE) %>% 
  mutate(type = "mutated") %>% 
  rbind(contacts.a.f %>% 
          mutate(type = "original") %>% 
          merge(CDR3.orig))
```


#Potential
```{r}
potential <- fread("TCRen.csv") %>% 
  melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")
```

#Reference values of potential for real complexes
```{r}
reference_values_pdb <- fread("~/struct2020/contacts_a_new.csv") %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  merge(potential) %>% 
  group_by(pdb.id, potential) %>% 
  summarise(value.s = sum(value)) 

qplot(reference_values_pdb$value.s)
```

# Rank peptides
```{r}
energy.mut.pep <- contacts.mut.pep %>% 
  merge(potential) %>% 
  group_by(pdb.id, peptide, potential, type) %>% 
  summarise(value.s = sum(value)) %>% 
  arrange(pdb.id, value.s)

energy.mut.pep %>% 
  select(-value.s) %>% 
  merge(reference_values_pdb %>% select(pdb.id.ref = pdb.id, value.s)) %>% 
  mutate(type.2 = "reference") %>% 
  rbind(energy.mut.pep %>% 
          mutate(pdb.id.ref = pdb.id,
                 type.2 = "calc")) %>% 
  group_by(pdb.id, peptide, potential, type) %>% 
  mutate(percentile = rank(value.s) / n()) %>% 
  filter(type.2 != "reference") %>% 
  select(pdb.id, peptide, potential, type, value.s, percentile) %>% 
  arrange(pdb.id, potential, value.s)
```

# Rank CDR3
```{r}
contacts.mut.CDR3 %>% 
  merge(potential) %>% 
  group_by(pdb.id, chain.type.from, potential, type) %>% 
  summarise(value.s = sum(value)) %>% 
  arrange(pdb.id, chain.type.from, value.s)
```



