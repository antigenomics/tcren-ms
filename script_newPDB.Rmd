---
title: "Untitled"
output: html_document
---

For its work the script reqiures (in the same folder):
1) mir-1.0-SNAPSHOT.jar
2) PDB(s) structures for in silico peptide screening 
3) list of PDB file names, each in a separate line, no header
4) (optional) df with peptides for peptide screening (1st col: PDB name, 2nd col: peptide)
5) (optional) df with CDR3s for CDR3 screening (1st col: PDB name, 2nd col: chain (TRA or TRB), 3rd col: CDR3 seq)

```{r}
library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
library(magrittr)
#library(ggbeeswarm)
```

```{r}
#fread("~/struct2020/TCRen.csv") %>% 
#  select(residue.aa.from, residue.aa.to, TCRen = TCRen.005) %>% 
#  mutate(TCRen = -TCRen) %>% 
#  fwrite("TCRen.csv")
```

# PDB list

```{r}
pdb_list <- dir("../struct")
```


#Annotation of structures and contacts by MIR
```{r}
MEMORY <- "20G"

run_mir <- function(pdb_list,
                     mir_path = "mir-1.0-SNAPSHOT.jar", 
                     output_dir = "mir_output",
                     arg, #"annotate-structures", "compute-pdb-geom", "compute-pdb-contacts"
                     print_log = T) {
  #.pdb_list <- pdb_list$pdb.id %>% paste(collapse = " ")
  .pdb_list <- paste0("../struct/", pdb_list) %>% paste(collapse = " ")
  dir.create(output_dir, showWarnings = FALSE)
  cmd <- str_glue("java -Xmx{MEMORY} -cp {mir_path} com.milaboratory.mir.scripts.Examples {arg} -I {.pdb_list} -O ./{output_dir}/")
  code <- system(cmd,
                 ignore.stdout = !print_log, 
                 ignore.stderr = !print_log)
  if(code != 0) {
    stop(str_glue("Failed to execute '{cmd}'"))
  }
}
system("java -version")
```

```{r}
run_mir(pdb_list = pdb_list, arg = "annotate-structures")
run_mir(pdb_list = pdb_list, arg = "compute-pdb-contacts")
```

# Candidate peptides

```{r}
pdb.peptides <- fread("mir_output/general.txt") %>% 
  filter(chain.component == "PEPTIDE") %>% 
  select(pdb.id, peptide = allele.info)

peptide_list <- pdb.peptides %>% 
  rename(peptide.pdb = peptide) %>% 
  mutate(pep.length = nchar(peptide.pdb)) %>% 
  slice(rep(1:n(), each = 200)) %>% 
  rowwise() %>% 
  mutate(peptide = paste0(stri_rand_strings(1, 1, aa.re), substr(peptide.pdb, 2, 2), stri_rand_strings(1, pep.length-3, aa.re), substr(peptide.pdb, pep.length, pep.length))) %>% 
  select(pdb.id, peptide) %>% 
  mutate(real = F) %>% 
  rbind(pdb.peptides %>% 
          mutate(real = T))


```


# Processing of MIR output
```{r}
contacts <- fread("mir_output/atomdist.txt") %>%
  filter(dist <= 5, chain.id.from != chain.id.to) %>%
  select(-atom.from, -atom.to, -dist) %>%
  unique
  
contacts.a <- rbind(
  contacts,
  contacts %>% 
    rename(chain.id.from = chain.id.to,
           chain.id.to = chain.id.from,
           residue.index.from = residue.index.to,
           residue.index.to = residue.index.from)
)

general_resmarkup <- fread("mir_output/general.txt") %>% 
  merge(fread("mir_output/resmarkup.txt", blank.lines.skip = T)) %>% 
  group_by(pdb.id, chain.id, region.type) %>% 
  mutate(region.start = min(residue.index)) %>% 
  ungroup 
  

contacts.a.f <- contacts.a %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.from = chain.type, chain.id.from = chain.id,
                 residue.index.from = residue.index, residue.aa.from = residue.aa,
                 region.type.from = region.type, region.start.from = region.start)) %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.to = chain.type, chain.id.to = chain.id, 
                 residue.index.to = residue.index, residue.aa.to = residue.aa,
                 region.type.to = region.type, region.start.to = region.start)) %>% 
  mutate(pos.from = residue.index.from - region.start.from,
         pos.to = residue.index.to - region.start.to) %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  select(pdb.id, chain.type.from, region.type.from, 
         pos.from, pos.to, residue.aa.from, residue.aa.to)
```



# Generate contact maps for mutated complexes

## peptide mutation
```{r}
pep_len_max <- nchar(peptide_list$peptide) %>% max()
#pep_len_max <- 9

contacts.mut.pep <- peptide_list %>% 
  separate(peptide, into = as.character(c(0:(pep_len_max-1))), sep = 1:pep_len_max, remove = F) %>% 
  melt(id = c("pdb.id", "peptide"), variable.name = "pos.to", value.name = "residue.aa.to") %>%
  mutate(pos.to = as.integer(as.character(pos.to))) %>% 
  merge(contacts.a.f %>% 
          select(-residue.aa.to), allow.cartesian=TRUE) %>% 
  mutate(type = "mutated") %>% 
  rbind(contacts.a.f %>% 
          mutate(type = "original") %>% 
          merge(fread("mir_output/markup.txt") %>% 
                  filter(region.type == "PEPTIDE") %>% 
                  select(pdb.id, peptide = region.sequence)))
```



#Potential
```{r}
potential <- fread("TCRen.csv") %>% 
  melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")

potential <- TCRen %>% 
  rbind(potential)
```

#Reference values of potential for real complexes
```{r}
reference_values_pdb <- fread("~/struct2020/contacts_a_new.csv") %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  merge(potential) %>% 
  group_by(pdb.id, potential) %>% 
  summarise(value.s = sum(value)) 

qplot(reference_values_pdb$value.s)
```

# Rank peptides
```{r}
energy.mut.pep <- contacts.mut.pep %>% 
  merge(potential) %>% 
  group_by(pdb.id, peptide, potential, type) %>% 
  summarise(value.s = sum(value)) %>% 
  arrange(pdb.id, value.s)

#energy.mut.pep.s <- energy.mut.pep %>% 
#  select(-value.s) %>% 
#  merge(reference_values_pdb %>% select(pdb.id.ref = pdb.id, value.s)) %>% 
#  mutate(type.2 = "reference") %>% 
#  rbind(energy.mut.pep %>% 
#          mutate(pdb.id.ref = pdb.id,
#                 type.2 = "calc")) %>% 
#  group_by(pdb.id, peptide, potential, type) %>% 
#  mutate(percentile = rank(value.s) / n()) %>% 
#  filter(type.2 != "reference") %>% 
#  select(pdb.id, peptide, potential, type, value.s, percentile) %>% 
#  arrange(pdb.id, potential, value.s)
```

```{r}
energy.mut.pep %>% 
  group_by(potential) %>% 
  mutate(rank = rank(value.s) / n()) %>% 
  filter(type == "original") %>% 
  ggplot(aes(x = potential, y = rank)) +
  geom_beeswarm() +
  geom_boxplot(alpha = 0) +
  geom_violin(alpha = 0)

energy.mut.pep %>% 
  group_by(potential) %>% 
  mutate(rank = rank(value.s) / n()) %>% 
  filter(type == "original") %>% 
  ggplot(aes(x = potential, y = rank)) +
  geom_beeswarm() +
  geom_boxplot(alpha = 0) +
  geom_violin(alpha = 0)

```

```{r}
energy.mut.pep %>% 
  group_by(potential) %>% 
  mutate(rank = rank(value.s) / n()) %>% 
  filter(type == "original",
         potential == "TCRen") %>% 
  arrange(peptide, pdb.id) %>% 
  group_by(peptide) %>% 
  slice(1) %>% 
  .$pdb.id -> pdb_list.new
```

```{r}
tibble(pdb.id = pdb.nonred) %>% 
  fwrite("~/shared-with-me/struct2020/pdb_nonred_list.txt")
```


```{r}
energy.mut.pep %>% 
  filter(pdb.id %in% pdb_list.new) %>% 
  filter(potential == "TCRen") %>% 
  ggplot(aes(x = pdb.id, y = value.s)) +
  geom_quasirandom(size = 1, aes(color = type), width = .2, size = .1) +
  geom_boxplot(alpha = 0, width = .2) +
  geom_point(data = energy.mut.pep %>% filter(potential == "TCRen", type == "original", pdb.id %in% pdb_list.new), size = 2, color = "#00BFC4") +
  theme_bw() +
  theme(legend.position = "top") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) #+
  #facet_wrap(~pdb.id, scales = "free")
```

```{r}
energy.mut.pep %>% 
  filter(potential == "TCRen") %>% 
  ggplot(aes(x = pdb.id, y = value.s, )) +
  geom_quasirandom(size = 1, aes(color = type), width = .2) +
  geom_boxplot(alpha = 0, width = .2) +
  theme_bw() +
  theme(legend.position = "top",
        )#+
  #facet_wrap(~pdb.id, scales = "free")
```


```{r}
contacts.a.f %>%
  filter(pdb.id == "6v18.pdb") %>%
  merge(TCRen) %>%
  merge(counts.total) %>% 
  filter(potential == "TCRen.a.cf") %>%
  select(-potential)  %>%
  arrange(-value)

contacts.a.f %>%
  filter(pdb.id == "6vrm.pdb") %>%
  merge(TCRen) %>%
  merge(counts.total) %>% 
  filter(potential == "TCRen.a.cf") %>%
  select(-potential)  %>%
  arrange(-value)
```

```{r}
q1 <- energy.mut.pep$pdb.id %>% unique() %>% sort()

q2 <- contacts$pdb.id %>% unique() %>% sort()

q2[!q2 %in% q1]

general_resmarkup$pdb.id %>% unique() %>% sort()

peptide_list$pdb.id %>% unique() %>% sort()

contacts.a$pdb.id %>% unique() %>% sort()

```

```{r}
general_resmarkup %>% 
  filter(pdb.id == "6ulr.pdb") %>% 
  merge(counts.total) %>% 
  group_by(chain.id) %>% 
  summarise(n = n())

contacts.a %>% 
  filter(pdb.id == "6ulr.pdb") %>% 
  merge(counts.total) %>%
  group_by(chain.id.from, chain.id.to) %>% 
  summarise(n = n())

contacts.a.f %>% 
  filter(pdb.id == "6ulr.pdb")
```


```{r}
contacts.a %>% 
  filter(pdb.id == "6ulr.pdb") %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.from = chain.type, chain.id.from = chain.id,
                 residue.index.from = residue.index, residue.aa.from = residue.aa,
                 region.type.from = region.type, region.start.from = region.start)) %>% 
  merge.data.frame(general_resmarkup %>% 
          select(pdb.id, chain.type.to = chain.type, chain.id.to = chain.id, 
                 residue.index.to = residue.index, residue.aa.to = residue.aa,
                 region.type.to = region.type, region.start.to = region.start)) %>% 
  mutate(pos.from = residue.index.from - region.start.from,
         pos.to = residue.index.to - region.start.to) %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  select(pdb.id, chain.type.from, region.type.from, 
         pos.from, pos.to, residue.aa.from, residue.aa.to)
```
```{r}
counts.total <- counts %>% 
  group_by(residue.aa.from) %>% 
  mutate(total.from = sum(count)) %>%
  group_by(residue.aa.to) %>% 
  mutate(total.to = sum(count),
         rank.from = rank(total.from)) %>%
  group_by(residue.aa.from) %>% 
  mutate(rank.to = rank(total.to)) 
```

