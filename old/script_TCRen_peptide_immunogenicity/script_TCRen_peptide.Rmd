---
title: "Mean TCRen for peptides"
author: "Vadim Karnaukhov"
date: "09 06 2021"
output: html_document
---

# Read dataframe with pairwise potential
File contains 3 columns: "residue.aa.from" (amino acid on TCR side), "residue.aa.to" (amino acid on peptide side), "TCRen" (value of pairwise energy of interaction; the lower, the more energetically favorable)

```{r}
potential <- fread("TCRen.csv")
```


# Amino acid composition (AAComp) of CDR3 in TCR repertoires

Precomputed AAcomp from Emerson data
Consider CDR3 sequence without first and last 4 residues which almost never contact peptide
```{r}
AAComp.CDR3 <- tibble(aminoacid = c("R","K","N","D","Q","E","H","P","Y","W","S","T","G","A","M","C","F","L","V","I"),
                 fraction = c(0.065,0.011,0.064,0.054,0.055,0.044,0.009,0.049,0.056,0.010,0.089,0.083,0.209,0.061,0.006,0.000,0.017,0.067,0.036,0.014),
                 organism = "Human")
```

# Compute average values of TCRen potential for residues in peptide side
Normalized on amino acid composition of CDR3 in TCR repertoires

```{r}
potential.mean.pep <- potential %>% 
  merge(AAComp.CDR3 %>% 
          select(residue.aa.from = aminoacid, fraction)) %>% 
  group_by(residue.aa.to) %>% 
  summarise(TCRen.mean = sum(TCRen * fraction))
```

```{r}
# Function for calculation of average TCRen for CDR3's in repertoire
# Input: a dataframe with "peptide" column
# Output: a dataframe with the same columns as in input + "TCRen.mean.sum" (sum of TCRen.mean values for peptide residues), "TCRen.mean.mean" (average TCRen.mean value for peptide residues)
# Consider peptide sequence without the second and the last residues which are usually anchors

TCRen.mean.pep_calc <- function(df) {
  
  max.len.pep <- df$peptide %>% nchar() %>% max()
  
  df %>% 
    select(peptide) %>% 
    mutate(pep.len = nchar(peptide)) %>% 
    separate(peptide, into = paste0("p", 1:max.len.pep), 
                      sep = 1:max.len.pep, remove = F) %>% 
             melt(id = c("peptide", "pep.len"), variable.name = "position", value.name = "aminoacid") %>% 
    filter(position != "p2",
           position != paste0("p", pep.len)) %>% 
    merge(potential.mean.pep %>% 
            select(aminoacid = residue.aa.to, TCRen.mean)) %>% 
    group_by(peptide) %>% 
    summarise(TCRen.mean.sum = sum(TCRen.mean),
              TCRen.mean.mean = mean(TCRen.mean)) %>% 
    merge(df) # so as to save information from the other columns of the original df
}
```


# Compare TCRen.mean for immunogenic and non-immunogenic peptides from Chowell and Koohy datasets

Compute TCRen.mean.sum and TCRen.mean.mean for Chowell and Koohy datasets
```{r}
chowell <- fread("chowell.txt") %>% 
  rename(peptide = antigen.epitope) %>% 
  mutate(pep.len = nchar(peptide)) %>% 
  TCRen.mean.pep_calc()


koohy <- fread("tcell_filtered.csv") %>%
  filter(Qualitative.Measure %in% c("Positive", "Negative"),
         Class == "I") %>% 
  select(peptide = Description, immunogenicity = Qualitative.Measure, hla = Allele.Name) %>% 
  distinct(peptide, .keep_all = T) %>% 
  mutate(pep.len = nchar(peptide)) %>% 
  filter(pep.len <= 12)  %>% 
  TCRen.mean.pep_calc()
```

```{r}
chowell %>% 
  ggplot(aes(x = immunogenicity, y = TCRen.mean.sum)) +
  geom_boxplot() +
  geom_quasirandom(size = .1) +
  theme_bw() 
    

chowell %>% ungroup() %>% 
  select(-peptide) %>% 
  t.test(TCRen.mean.sum ~ immunogenicity, data = .)

koohy %>% 
  ggplot(aes(x = immunogenicity, y = TCRen.mean.sum)) +
  geom_boxplot() +
  geom_quasirandom(size = .1) +
  theme_bw() 


koohy %>% ungroup() %>% 
    select(-peptide) %>% 
    t.test(TCRen.mean.sum ~ immunogenicity, data = .)

```

