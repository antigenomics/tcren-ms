---
title: "Untitled"
author: "Vadim Karnaukhov"
date: "13 01 2021"
output: html_document
---

```{r}
contacts.a.2 <- contacts.a %>%
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE" | 
           startsWith(region.type.to, "CDR") & region.type.from == "PEPTIDE") %>%
  group_by(type = "cdrps", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())
```


```{r Changed}
potentials <- fread("~/struct2020/TCRen_MJ.csv") %>% 
  merge(fread("~/struct2020/contacts_a_s.csv") %>% 
          select(type, residue.aa.from, residue.aa.to, odds) %>% 
          dcast(residue.aa.from + residue.aa.to ~ type)) %>% 
  select(-odds, -E1, -E2, -E12)

cor(potentials[,-c(1,2)])
```




Function for creation of a dataframe with contacts between CDR3 and peptide starting from MIR output
```{r}
#dir_name <- "benchmark/TCR55/6bj8/out_mir/"

df_contacts <- function(dir_name) {
  contacts <- fread(paste0(dir_name, "atomdist.txt")) %>%
    filter(dist <= 5, chain.id.from != chain.id.to) %>%
    select(-atom.from, -atom.to, -dist) %>%
    unique
  
  contacts.1 <- contacts
  contacts.1$chain.id.from <- contacts$chain.id.to
  contacts.1$chain.id.to <- contacts$chain.id.from
  contacts.1$residue.index.from <- contacts$residue.index.to
  contacts.1$residue.index.to <- contacts$residue.index.from
  
  contacts <- contacts %>%
    rbind(contacts.1)
  
  resmarkup <- fread(paste0(dir_name, "resmarkup.txt"), blank.lines.skip = T)
  
  general <- fread(paste0(dir_name, "general.txt"))
  
  resmarkup.a <- resmarkup %>%
    merge(general)
  
  #merge = data.table::merge.data.table
  
  contacts.a <- contacts %>%
    merge(resmarkup.a %>% mutate(chain.id.from = chain.id,
                                 chain.type.from = chain.type,
                                 chain.supertype.from = chain.supertype,
                                 region.type.from = region.type,
                                 residue.index.from = residue.index,
                                 residue.aa.from = residue.aa) %>%
            select(pdb.id, chain.id.from, chain.type.from, chain.supertype.from,
                   complex.species,
                   region.type.from, residue.index.from, residue.aa.from)) %>%
    merge(resmarkup.a %>% mutate(chain.id.to = chain.id,
                                 chain.type.to = chain.type,
                                 chain.supertype.to = chain.supertype,
                                 region.type.to = region.type,
                                 residue.index.to = residue.index,
                                 residue.aa.to = residue.aa) %>%
            select(pdb.id, chain.id.to, chain.type.to, chain.supertype.to,
                   region.type.to, residue.index.to, residue.aa.to),
          by = c("pdb.id", "chain.id.to", "residue.index.to"))
  
  resides.from <- resmarkup %>%
    merge(general) %>%
    filter(startsWith(region.type, "CDR3")) %>%
    mutate(chain.type.from = chain.type,
           region.type.from = region.type,
           residue.index.from = residue.index,
           residue.aa.from = residue.aa) %>%
    group_by(pdb.id, chain.type.from, region.type.from) %>%
    mutate(pos.from = residue.index.from - min(residue.index.from),
           len.from = max(pos.from) + 1) %>%
    select(pdb.id, chain.type.from, region.type.from, residue.index.from, 
           pos.from, len.from, residue.aa.from) %>%
    ungroup %>%
    arrange(pdb.id, chain.type.from, residue.index.from)
  
  resides.to <- resmarkup %>%
    merge(general) %>%
    filter(region.type == "PEPTIDE") %>%
    mutate(chain.type.to = chain.type,
           region.type.to = region.type,
           residue.index.to = residue.index,
           residue.aa.to = residue.aa) %>%
    group_by(pdb.id, chain.type.to, region.type.to) %>%
    mutate(pos.to = residue.index.to - min(residue.index.to),
           len.to = max(pos.to) + 1) %>%
    select(pdb.id, chain.type.to, region.type.to, residue.index.to, 
           pos.to, len.to, residue.aa.to) %>%
    ungroup %>%
    arrange(pdb.id, chain.type.to, residue.index.to)
  
  resides.comb <- resides.from %>%
    merge.data.frame(resides.to)
  
  contacts.real <- resides.comb %>%
    merge(contacts.a %>%
            #filter(region.type.from == "CDR3", chain.type.to == "PEPTIDE") %>%
            mutate(contact = 1) %>%
            select(pdb.id, chain.type.from, residue.index.from, residue.index.to, contact),
          all.x = T) %>%
    mutate(contact = ifelse(is.na(contact), 0, contact)) %>% 
    merge.data.frame(general %>% 
            filter(chain.component == "PEPTIDE") %>% 
            select(pdb.id, peptide = allele.info))
  
  return(contacts.real)
  #contacts.real %>% 
  #  filter(contact == 1) %>% 
  #  group_by(pdb.id) %>% 
  #  summarise(n = n()) %>% 
  #  arrange(-n) %>% 
  #  ggplot(aes(x = n)) +
  #  geom_histogram(binwidth = 1)
}
```

## Function for summarising TCRen and MJ

```{r Changed}
summarise_TCRen_MJ <- function(df) {
  df %>%   
    summarize(mj.s = sum(mj * contact),
              mj2.s = sum(mj2 * contact),            
              all.s = -sum(all * contact),
              cdrps.s = -sum(cdrps * contact),
              cdrpa.s = -sum(cdrpa * contact))
}
```


##TCR55 test case (https://www.sciencedirect.com/science/article/pii/S0092867418307852#bib6)

```{r}
B35.epitopes <- iedb %>%
  mutate(Peptide.length = nchar(as.character(Epitope.2))) %>%
  filter(Epitope.1 == "Linear peptide", 
         MHC == 'HLA-B*35:01',
         Peptide.length == 9,
         Assay.5 != "Negative") %>% 
  select(Epitope.2, MHC, Peptide.length) %>%
  filter(substr(Epitope.2, 2, 2) == "P",
         substr(Epitope.2, 3, 3) != "L",
         substr(Epitope.2, 4, 4) != "T",
         !substr(Epitope.2, 5, 5) %in% c("D", "E"),
         !substr(Epitope.2, 6, 6) %in% c("D", "E"),
         substr(Epitope.2, 7, 7) != "A",
         substr(Epitope.2, 8, 8) != "E",
         substr(Epitope.2, 9, 9) %in% c("L", "M", "I", "F", "Y")) 

B35.epitopes %>% 
  select(peptide = Epitope.2) %>% 
  fwrite("~/shared-with-me/struct2020/benchmark/TCR55/iedb_B3501.csv")
```

```{r}
tcr55.peptides <- fread("benchmark/TCR55/display_TCR55.csv") %>% 
  mutate(group = "recognised") %>% 
  rbind(fread("benchmark/TCR55/iedb_B3501.csv") %>% 
          mutate(group = "iedb_B3501")) %>% 
  distinct()
```


### Functions for ROC AUC
```{r}
library(plotROC)
library(pROC)

plot_roc_curve <- function(df) {
  df %>% 
    ggplot(aes(d = group, m = -value, color = potential)) +
    geom_vline(xintercept = 1, size = 1) +
    geom_abline(intercept = 1, slope = 0, size = 1) +
    geom_roc(n.cuts = 0, size = .5) + 
    style_roc(major.breaks = c(0, 0.25, 0.5, 0.75, 1), minor.breaks = F, theme = theme_classic) + 
    geom_abline(intercept = 0, slope = 1, linetype="dashed") +
    labs(color = "Potential", x = 'False positive rate', y = 'True positive rate') +
    scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))
}

plot_potentials <- function(df) {
  df %>% 
    ggplot(aes(x = group, y = value)) +
    facet_wrap(~potential, scales = "free_y", nrow = 2) +
    geom_quasirandom(size = .5) +
    geom_boxplot(alpha = 0, color = 'red') +
    theme_minimal()
}

calc_roc_auc <- function(df1) {
  print("")
  for (pot in df1$potential %>% unique()) {
    df <- df1 %>% 
        filter(potential == pot) #%>% 
        #mutate(group = (group == "recognised"))
    roc_auc <- auc(roc(df$group, df$value, direction = ">", levels = c(F,T)))
    cat(paste(round(roc_auc, 2), "\t", pot, "\n"))
  }  
}
```



Function for calculation of energy of interaction (TCRen, MJ and others) starting from df_contacts df

```{r}
#tcr55.contacts <- df_contacts("benchmark/TCR55/6bj3/out_mir/")

tcr55.energy <- tcr55.contacts %>% 
  merge.data.frame(tcr55.peptides) %>% 
  merge.data.frame(potentials) %>% 
  group_by(pdb.id, group) %>% 
  summarise_TCRen_MJ()  

tcr55.energy.a <- tcr55.energy %>% 
  melt(id = c("pdb.id", "group"), variable.name = "potential") 

tcr55.energy.a %>% 
  mutate(group = (group == "recognised")) %>% 
  plot_roc_curve()

tcr55.energy.a %>% 
  plot_potentials()

tcr55.energy.a %>% 
  mutate(group = (group == "recognised")) %>%
  calc_roc_auc()
```


##DMF5 test case (Gee et al., 2018)

```{r}
A02.epitopes <- iedb %>%
  mutate(Peptide.length = nchar(as.character(Epitope.2))) %>%
  filter(Epitope.1 == "Linear peptide", 
         MHC == 'HLA-A*02:01',
         Peptide.length == 10,
         Assay.5 != "Negative") %>% 
  select(Epitope.2, MHC, Peptide.length) %>%
  filter(substr(Epitope.2, 2, 2) %in% c("L", "M"),
         !substr(Epitope.2, 4, 4) %in% c("G", "D"),
         !substr(Epitope.2, 5, 5) %in% c("I", "L", "R"),
         substr(Epitope.2, 6, 6) != "G",
         substr(Epitope.2, 7, 7) != "I",
         substr(Epitope.2, 10, 10) %in% c("L", "M", "V")) 

A02.epitopes %>% 
  select(peptide = Epitope.2) %>% 
  fwrite("~/shared-with-me/struct2020/benchmark/DMF5/iedb_A0201.csv")
```

```{r}
dmf5.peptides <- fread("benchmark/DMF5/display_GIG.csv") %>% 
  mutate(group = "GIG") %>% 
  rbind(fread("benchmark/DMF5/display_DRG.csv") %>% 
          mutate(group = "DRG")) %>% 
  rbind(fread("benchmark/DMF5/iedb_A0201.csv") %>% 
          mutate(group = "iedb_A0201")) %>%
  rbind(fread("benchmark/DMF5/display_GIG_conf.csv") %>% 
          mutate(group = "GIG")) %>% 
  rbind(fread("benchmark/DMF5/display_DRG_conf.csv") %>% 
          mutate(group = "DRG")) %>% 
  merge(fread("benchmark/DMF5/display_GIG_conf.csv") %>% 
          mutate(confirmed = 1) %>% 
          rbind(fread("benchmark/DMF5/display_DRG_conf.csv") %>% 
                  mutate(confirmed = 1)), 
        all = T) %>% 
  mutate(confirmed = replace_na(confirmed, 0)) %>% 
  distinct()
```

```{r}
dmf5_GIG.contacts <- df_contacts("benchmark/DMF5/3qdg/out_mir/")

dmf5_GIG.energy <- dmf5_GIG.contacts %>% 
  merge.data.frame(dmf5.peptides) %>% 
  merge.data.frame(potentials) %>% 
  group_by(pdb.id, group, confirmed) %>% 
  summarise_TCRen_MJ()  

dmf5_GIG.energy.a <- dmf5_GIG.energy %>% 
  melt(id = c("pdb.id", "group", "confirmed"), variable.name = "potential") 

dmf5_GIG.energy.a %>% 
  mutate(group = (group == "GIG")) %>% 
  plot_roc_curve()

dmf5_GIG.energy.a %>% 
  mutate(group = (group == "GIG")) %>%
  calc_roc_auc()

dmf5_GIG.energy.a %>% 
  ggplot(aes(x = group, y = value, color = factor(confirmed))) +
  facet_wrap(~potential, scales = "free_y", nrow = 2) +
  geom_quasirandom(size = .3) +
  geom_boxplot(alpha = .3) +
  scale_color_manual(values = c("black", "red")) +
  theme_minimal() +
  theme(legend.position = "None")


dmf5_GIG.energy.a %>% 
  mutate(group = (group == "DRG")) %>% 
  plot_roc_curve()

dmf5_GIG.energy.a %>% 
  mutate(group = (group == "DRG")) %>%
  calc_roc_auc()
```

```{r}
dmf5_DRG.contacts <- df_contacts("benchmark/DMF5/6amu/out_mir/")

dmf5_DRG.energy <- dmf5_DRG.contacts %>% 
  merge.data.frame(dmf5.peptides) %>% 
  merge.data.frame(potentials) %>% 
  group_by(pdb.id, group, confirmed) %>% 
  summarise_TCRen_MJ()  

dmf5_DRG.energy.a <- dmf5_DRG.energy %>% 
  melt(id = c("pdb.id", "group", "confirmed"), variable.name = "potential") 

dmf5_DRG.energy.a %>% 
  mutate(group = (group == "GIG")) %>% 
  plot_roc_curve()

dmf5_DRG.energy.a %>% 
  mutate(group = (group == "GIG")) %>%
  calc_roc_auc()

dmf5_DRG.energy.a %>% 
  ggplot(aes(x = group, y = value, color = factor(confirmed))) +
  facet_wrap(~potential, scales = "free_y", nrow = 2) +
  geom_quasirandom(size = .3) +
  geom_boxplot(alpha = .3) +
  scale_color_manual(values = c("black", "red")) +
  theme_minimal() +
  theme(legend.position = "None")


dmf5_DRG.energy.a %>% 
  mutate(group = (group == "DRG")) %>% 
  plot_roc_curve()

dmf5_DRG.energy.a %>% 
  mutate(group = (group == "DRG")) %>%
  calc_roc_auc()

```
```{r}
library(ggpubr)

dmf5_GIG_DRG <- dmf5_GIG.energy.a %>% 
  rename(peptide = pdb.id, GIG = value) %>% 
  mutate(peptide = str_split_fixed(peptide, "[_.]", 4)[,3]) %>% 
  merge(dmf5_DRG.energy.a %>% 
          rename(peptide = pdb.id, DRG = value) %>%
          mutate(peptide = str_split_fixed(peptide, "[_.]", 4)[,3])) %>% 
  melt(id = c("peptide", "group", "confirmed", "potential"), variable.name = "template") 

stat.test <- dmf5_GIG_DRG %>%
    group_by(potential, group) %>%
    wilcox_test(value ~ template) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance()
stat.test <- stat.test %>% #add_y_position()
  add_xy_position(x = "group", dodge = 0.8)

dmf5_GIG_DRG %>% 
  ggplot(aes(x = group, y = value, color = template)) +
  facet_wrap(~potential, scales = "free") +
  geom_boxplot() +
  geom_quasirandom(dodge.width = .75, size = .1) +
  #stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  theme_bw()
dmf5_GIG_DRG %>% 
  ggplot(aes(x = group, y = value, color = template)) +
  facet_wrap(~potential, scales = "free") +
  geom_boxplot() +
  geom_quasirandom(dodge.width = .75, size = .1) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  theme_bw()

stat.test <- dmf5_GIG_DRG %>%
    group_by(potential, template) %>%
    wilcox_test(value ~ group) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance()
stat.test <- stat.test %>% #add_y_position()
  add_xy_position(x = "template", dodge = 0.5)

dmf5_GIG_DRG %>% 
  ggplot(aes(x = template, y = value, color = group)) +
  facet_wrap(~potential, scales = "free_y") +
  geom_boxplot() +
  geom_quasirandom(dodge.width = .75, size = .1) +
  #stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  theme_bw()
dmf5_GIG_DRG %>% 
  ggplot(aes(x = template, y = value, color = group)) +
  facet_wrap(~potential, scales = "free_y") +
  geom_boxplot() +
  geom_quasirandom(dodge.width = .75, size = .1) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0.01) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  theme_bw()


```



## Shuffled complexes with matched CDR3a, CDR3b and peptide lengths


```{r}
pdb.mhci <- fread("out/general.txt") %>% 
  filter(chain.supertype == "MHCI") %>% 
  .$pdb.id %>% unique()

markup <- read.table("out/markup.txt", fill = T, header = T) %>%
  merge(fread("out/general.txt") %>%
          select(-chain.component, -chain.supertype, -seq.length)) %>% 
  filter(pdb.id %in% pdb.mhci)

markup.a <- markup %>%
    filter(chain.type == "TRA" & region.type == "CDR3") %>%
    select(pdb.id, cdr3a = region.sequence) %>%
    unique() %>%
  merge(markup %>%
    filter(chain.type == "TRB" & region.type == "CDR3") %>%
    select(pdb.id, cdr3b = region.sequence) %>%
    unique()) %>% 
  merge(markup %>%
    filter(chain.type == "PEPTIDE") %>%
    select(pdb.id, peptide = region.sequence) %>%
    unique()) %>% 
  mutate(cdr3a.length = nchar(cdr3a),
         cdr3b.length = nchar(cdr3b),
         peptide.length = nchar(peptide)) %>% 
  filter(peptide.length < 14)  #to avoid CD1 cases
```

```{r}
library(stringdist)

pdb.pairs <- expand.grid(pdb.id.from = markup.a$pdb.id,
            pdb.id.to = markup.a$pdb.id) %>% 
  merge.data.frame(markup.a %>% 
          select(pdb.id.from = pdb.id, 
                 cdr3a.from = cdr3a,
                 cdr3b.from = cdr3b,
                 peptide.from = peptide,
                 cdr3a.length.from = cdr3a.length, 
                 cdr3b.length.from = cdr3b.length, 
                 peptide.length.from = peptide.length)) %>% 
  merge.data.frame(markup.a %>% 
          select(pdb.id.to = pdb.id, 
                 cdr3a.to = cdr3a,
                 cdr3b.to = cdr3b,
                 peptide.to = peptide,
                 cdr3a.length.to = cdr3a.length, 
                 cdr3b.length.to = cdr3b.length, 
                 peptide.length.to = peptide.length)) 

shuffled.pairs <- pdb.pairs %>% 
  filter(cdr3a.length.from == cdr3a.length.to,
         cdr3b.length.from == cdr3b.length.to,
         peptide.length.from == peptide.length.to) %>% 
  mutate(cdr3a.dist = stringdist(cdr3a.from, cdr3a.to, method = "hamming"),
         cdr3b.dist = stringdist(cdr3b.from, cdr3b.to, method = "hamming"),
         peptide.dist = stringdist(peptide.from, peptide.to, method = "hamming"),
         real = (pdb.id.to == pdb.id.from)) %>% 
  select(pdb.id.from, pdb.id.to, cdr3a.length = cdr3a.length.from, 
         cdr3b.length = cdr3b.length.from, peptide.length = peptide.length.from,
         cdr3a.dist, cdr3b.dist, peptide.dist, real)

shuffled.pairs <- shuffled.pairs %>% 
  filter(!real & cdr3a.dist > 3 & cdr3b.dist > 3 | real)

#qplot(shuffled.pairs$cdr3a.length.from, binwidth = 1)
#qplot(shuffled.pairs$cdr3b.length.from, binwidth = 1)
#qplot(shuffled.pairs$peptide.length.from, binwidth = 1)
```

```{r}
#!!! use variables from Misha's script
comb.sel.v <- tibble(chain.type.from = c("TRA", "TRB")) %>% 
  merge(shuffled.pairs %>% 
          select(pdb.id.from, pdb.id.to, real), 
        by = NULL)

resides.comb.v <- comb.sel.v %>%
  merge(resides.from) %>%
  merge(resides.to)
```

```{r}
contacts.real.v <- resides.comb.v %>%
  filter(real) %>%
  merge(contacts.a %>%
          filter(region.type.from == "CDR3", chain.type.to == "PEPTIDE") %>%
          #filter(chain.supertype.from == "TRAB", chain.supertype.to %in% c("MHCI", "PEPTIDE")),
          mutate(pdb.id.from = pdb.id, chain.type.from, contact = 1) %>%
          select(pdb.id.from, chain.type.from, residue.index.from, residue.index.to, contact),
        all.x = T) %>%
  mutate(contact = ifelse(is.na(contact), 0, contact))

contacts.all.v <- rbind(
  resides.comb.v %>%
    merge(contacts.real.v %>%
            mutate(perspective = "cdr") %>%
            select(perspective, pdb.id.from, chain.type.from, pos.from, pos.to, contact)),
  resides.comb.v %>%
    merge(contacts.real.v %>%
            mutate(perspective = "pep") %>%
            select(perspective, pdb.id.to, chain.type.from, pos.from, pos.to, contact))
)
```

```{r}
contacts.all.e.v <- contacts.all.v %>%
  merge(potentials)

contacts.all.e.s1.v <- contacts.all.e.v %>%
  group_by(real, pdb.id.from, pdb.id.to, chain.type.from, perspective) %>% # group by id, chain
  summarise_TCRen_MJ()
```

```{r}
contacts.all.e.s1.a.v <- contacts.all.e.s1.v %>%
  melt(id = c("pdb.id.from", "pdb.id.to", "chain.type.from", "perspective", "real"), variable.name = "potential") 

contacts.all.e.s1.a.v %>% 
  ggplot(aes(d = real, m = -value, color = potential)) +
  facet_grid(chain.type.from ~ perspective) +
  geom_vline(xintercept = 1, size = 1) +
  geom_abline(intercept = 1, slope = 0, size = 1) +
  geom_roc(n.cuts = 0, size = .5) + 
  style_roc(major.breaks = c(0, 0.25, 0.5, 0.75, 1), minor.breaks = F, theme = theme_classic) + 
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  labs(color = "Potential", x = 'False positive rate', y = 'True positive rate') +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))

cat(paste("TRA cdr perspective\n"))
for (pot in contacts.all.e.s1.a.v$potential %>% unique()) {
  df <- contacts.all.e.s1.a.v %>% 
      filter(chain.type.from == "TRA",
             perspective == "cdr",
             potential == pot)
  roc_auc <- auc(roc(df$real, df$value, direction = ">", levels = c(F,T)))
  cat(paste(round(roc_auc, 2), "\t", pot, "\n"))
}

cat(paste("\nTRB cdr perspective\n"))
for (pot in contacts.all.e.s1.a.v$potential %>% unique()) {
  df <- contacts.all.e.s1.a.v %>% 
      filter(chain.type.from == "TRB",
             perspective == "cdr",
             potential == pot)
  roc_auc <- auc(roc(df$real, df$value, direction = ">", levels = c(F,T)))
  cat(paste(round(roc_auc, 2), "\t", pot, "\n"))
}
```

```{r}
contacts.all.e.s2.v <- contacts.all.e.v %>%
  group_by(real, pdb.id.from, pdb.id.to, perspective) %>% # group by id, chain
  summarise_TCRen_MJ()

contacts.all.e.s2.a.v <- contacts.all.e.s2.v %>%
  melt(id = c("pdb.id.from", "pdb.id.to", "perspective", "real"), variable.name = "potential") 

contacts.all.e.s2.a.v %>% 
  ggplot(aes(d = real, m = -value, color = potential)) +
  facet_grid( ~ perspective) +
  geom_vline(xintercept = 1, size = 1) +
  geom_abline(intercept = 1, slope = 0, size = 1) +
  geom_roc(n.cuts = 0, size = .5) + 
  style_roc(major.breaks = c(0, 0.25, 0.5, 0.75, 1), minor.breaks = F, theme = theme_classic) + 
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  labs(color = "Potential", x = 'False positive rate', y = 'True positive rate') +
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))

cat(paste("cdr perspective\n"))
for (pot in contacts.all.e.s2.a.v$potential %>% unique()) {
  df <- contacts.all.e.s2.a.v %>% 
      filter(perspective == "cdr",
             potential == pot)
  roc_auc <- auc(roc(df$real, df$value, direction = ">", levels = c(F,T)))
  cat(paste(round(roc_auc, 2), "\t", pot, "\n"))
}

cat(paste("\npeptide perspective\n"))
for (pot in contacts.all.e.s2.a.v$potential %>% unique()) {
  df <- contacts.all.e.s2.a.v %>% 
      filter(perspective == "pep",
             potential == pot)
  roc_auc <- auc(roc(df$real, df$value, direction = ">", levels = c(F,T)))
  cat(paste(round(roc_auc, 2), "\t", pot, "\n"))
}
```
## Frequency of contacts of different res in peptide and CDR

In old redundant set
```{r}
contacts.a %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  group_by(pdb.id, chain.type.from, region.type.from) %>% 
  summarise(n = n()) %>% 
  merge(expand.grid(pdb.id = unique(contacts.a$pdb.id), 
                    chain.type.from = c("TRA", "TRB"), 
                    region.type.from = c("CDR1", "CDR2", "CDR3", "FR1", "FR2", "FR3")), all.y = T) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  ggplot(aes(x = region.type.from, y = n)) +
  facet_wrap(~chain.type.from) +
  #geom_violin() +
  geom_quasirandom(size = .1) +
  theme_bw()
```
In new nonred set
```{r}
contacts.a.new %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  group_by(pdb.id, chain.type.from, region.type.from) %>% 
  summarise(n = n()) %>% 
  merge(expand.grid(pdb.id = unique(.$pdb.id), 
                    chain.type.from = c("TRA", "TRB"), 
                    region.type.from = c("CDR1", "CDR2", "CDR3", "FR1", "FR2", "FR3")), all.y = T) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  ggplot(aes(x = region.type.from, y = n)) +
  facet_wrap(~chain.type.from) +
  #geom_violin() +
  geom_quasirandom(size = .1) +
  theme_bw()
```

```{r}
general.new <- fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/general.txt")

mhc.classes <- general.new %>% 
  filter(chain.supertype == "PEPTIDE") %>% 
  mutate(peptide = allele.info,
         pep.length = nchar(allele.info)) %>% 
  select(pdb.id, peptide, pep.length) %>% 
  merge(general.new %>% 
          filter(chain.component == "MHC") %>% 
          select(pdb.id, mhc.class = chain.supertype) %>% 
          distinct()) %>% 
  merge(general.new %>% 
          filter(chain.type == "MHCa") %>% 
          select(pdb.id, mhc.allele = allele.info) %>% 
          distinct()) %>% 
  filter(pep.length != 0,
         pep.length < 30) 

mhc.classes %>% 
  group_by(pep.length, mhc.class) %>% 
  summarise(n = n())

mhc.classes %>% 
  group_by(mhc.class, pep.length) %>% 
  summarise(n = n()) %>% 
  dcast(pep.length ~ mhc.class)
```


```{r, fig.height=15, fig.width=5}

contacts.pep.res <- contacts.a %>% 
  filter(chain.type.from %in% c("TRA", "TRB"),
         chain.type.to == "PEPTIDE") %>% 
  merge(resmarkup.a %>% 
          filter(region.type == "PEPTIDE") %>% 
          group_by(pdb.id) %>% 
          mutate(pep.start = min(residue.index)) %>% 
          select(pdb.id, pep.start, pep.length = seq.length) %>% 
          filter(pep.length < 30) %>% 
          distinct()) %>% 
  merge(mhc.classes) %>% 
  mutate(res.to = residue.index.to - pep.start) %>% 
  group_by(pdb.id, res.to, pep.length, mhc.class) %>% 
  summarise(n.cont = n())

contacts.pep.res %>% 
  merge(resmarkup.a %>% 
          filter(region.type == "PEPTIDE") %>% 
          group_by(pdb.id) %>% 
          mutate(pep.start = min(residue.index),
                 res.to = residue.index - pep.start) %>% 
          select(pdb.id, res.to, pep.length = seq.length),
        all.y = T) %>% 
  mutate(n.cont = replace_na(n.cont, 0)) %>% 
  filter(pdb.id %in% (mhc.classes %>% filter(mhc.class == "MHCI") %>% .$pdb.id)) %>% 
  ggplot(aes(x = res.to, y = n.cont, group = res.to)) +
  facet_wrap(~pep.length, ncol = 1, scales = "free_x") +
  expand_limits(y=0) +
  geom_boxplot()

contacts.pep.res %>% 
  merge(resmarkup.a %>% 
          filter(region.type == "PEPTIDE") %>% 
          group_by(pdb.id) %>% 
          mutate(pep.start = min(residue.index),
                 res.to = residue.index - pep.start) %>% 
          select(pdb.id, res.to, pep.length = seq.length),
        all.y = T) %>% 
  mutate(n.cont = replace_na(n.cont, 0)) %>% 
  filter(pdb.id %in% (mhc.classes %>% filter(mhc.class == "MHCII") %>% .$pdb.id)) %>% 
  ggplot(aes(x = res.to, y = n.cont, group = res.to)) +
  facet_wrap(~pep.length, ncol = 1, scales = "free_x") +
  expand_limits(y=0) +
  geom_boxplot()
```



Number of CDR-peptide contacts in different PDBs
```{r}
contacts.a.new <- fread("~/struct2020/contacts_a_new.csv")

pdb.contacts <- contacts.a.new %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE") %>% 
  group_by(pdb.id) %>% 
  summarise(n = n()) %>% 
  merge(mhc.classes) 

pdb.contacts %>% 
  ggplot(aes(x = n, color = factor(pep.length), group = factor(pep.length))) +
  facet_wrap(~mhc.class) +
  geom_density() +
  theme_bw()

pdb.contacts %>% 
  arrange(n)
```

### Normalization coefficients for peptides
```{r}
resmarkup.a.new <- fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/resmarkup.txt",
                         blank.lines.skip = T) %>% 
  merge(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/general.txt"))

contacts.peptide <- contacts.a.new %>% 
  filter(chain.supertype.from == "TRAB",
         chain.supertype.to == "PEPTIDE") %>% 
  group_by(pdb.id, residue.index.to) %>% 
  summarise(n = n()) %>% 
  merge(resmarkup.a.new %>% 
          filter(region.type == "PEPTIDE") %>% 
          select(pdb.id, residue.index.to = residue.index, residue.aa.to = residue.aa, pep.length = seq.length),
        all.y = T) %>%
  merge(mhc.classes) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  filter(pdb.id %in% pdb.nonred) 

contacts.peptide %>% 
  select(pdb.id, pep.length, mhc.class) %>% distinct() %>% 
  group_by(pep.length, mhc.class) %>%   
  summarise(n = n()) %>% 
  dcast(pep.length ~ mhc.class) 
  
contacts.peptide %>% 
  filter(pep.length == 9,
         mhc.class == "MHCI") %>% 
  ggplot(aes(x = residue.index.to, y = n, group = residue.index.to)) + 
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) + 
  theme_bw()
```

```{r, fig.height=30, fig.width=6}
contacts.peptide %>% 
  #group_by(pep.length, mhc.class, residue.index.to) %>% 
  #summarise(n.mean = mean(n)) %>% 
  ggplot(aes(x = factor(residue.index.to), y = n, group = residue.index.to)) +
  facet_wrap(~mhc.class + pep.length, scales = "free", ncol = 1) +
  geom_quasirandom() +
  theme_bw()
```

```{r}
contacts.peptide.coef <- contacts.peptide %>% 
  group_by(pep.length, mhc.class, residue.index.to) %>% 
  summarise(n.mean = mean(n)) 

contacts.peptide.coef %>% 
  ggplot(aes(x = factor(residue.index.to), y = n.mean, color = factor(pep.length), group = pep.length)) +
  facet_wrap(~mhc.class, ncol = 1, scales = "free") +
  geom_line() +
  theme_bw()
```
```{r}
contacts.total.to <- contacts.peptide %>% 
  select(pdb.id, residue.index.to, residue.aa.to, pep.length) %>% 
  merge(contacts.peptide.coef) %>% 
  mutate(n.flat = 1) %>% 
  group_by(residue.aa.to) %>% 
  summarise(total.to.mean = sum(n.mean),
            total.to.flat = sum(n.flat)) %>% 
  filter(residue.aa.to != "X")
```

### Calc total.from for CDR's
```{r}
contacts.cdr <- contacts.a.new %>% 
  filter(startsWith(region.type.from, "CDR"),
         chain.supertype.to == "PEPTIDE") %>% 
  group_by(pdb.id, chain.type.from, region.type.from, residue.index.from) %>% 
  summarise(n = n()) %>% 
  merge(resmarkup.a.new %>% 
          filter(startsWith(region.type, "CDR")) %>% 
          select(pdb.id, chain.type.from = chain.type, region.type.from = region.type,
                 residue.index.from = residue.index, residue.aa.from = residue.aa) %>% 
          group_by(pdb.id, chain.type.from, region.type.from) %>% 
          mutate(pos.from = residue.index.from - min(residue.index.from),
                 cdr.len = max(residue.index.from) - min(residue.index.from) + 1),
        all.y = T) %>%
  merge(mhc.classes) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  arrange(pdb.id, chain.type.from, region.type.from, residue.index.from)

contacts.cdr %>% 
  select(pdb.id, chain.type.from, region.type.from, cdr.len) %>% 
  distinct() %>% 
  group_by(chain.type.from, region.type.from, cdr.len) %>% 
  summarise(n = n()) %>% 
  #filter(n > 10) %>% 
  ggplot(aes(x = factor(cdr.len), y = n)) +
  geom_bar(stat = 'identity') +
  facet_wrap(chain.type.from ~ region.type.from, scales = 'free') +
  theme_bw()
```

```{r, fig.height=20, fig.width=12}
contacts.cdr %>% 
  #select(pdb.id, chain.type.from, region.type.from, cdr.len) %>% 
  filter(chain.type.from == "TRA",
         region.type.from == "CDR3") %>% 
  ggplot(aes(x = factor(pos.from), y = n, group = pos.from)) +
  facet_wrap(~cdr.len, scales = 'free', ncol = 2) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0, color = 'red') +
  theme_bw()
```  
```{r}
contacts.cdr %>% 
  #select(pdb.id, chain.type.from, region.type.from, cdr.len) %>% 
  filter(chain.type.from == "TRB",
         region.type.from == "CDR2") %>% 
  ggplot(aes(x = factor(pos.from), y = n, group = pos.from)) +
  facet_wrap(~cdr.len, scales = 'free', ncol = 2) +
  geom_quasirandom() +
  geom_boxplot(alpha = 0, color = 'red') +
  theme_bw()
```  

```{r}  
contacts.cdr.coef <- contacts.cdr %>% 
  group_by(chain.type.from, region.type.from, cdr.len, pos.from) %>% 
  summarise(n.mean = mean(n)) 

contacts.cdr.coef %>% 
  ggplot(aes(x = pos.from, y = n.mean, color = factor(cdr.len), group = cdr.len)) +
  facet_wrap(chain.type.from ~ region.type.from, scales = "free") +
  geom_line() +
  theme_bw()

contacts.total.from <- contacts.cdr %>% 
  select(pdb.id, chain.type.from, region.type.from, pos.from, residue.aa.from, cdr.len) %>% 
  merge(contacts.cdr.coef) %>% 
  mutate(n.flat = ifelse(region.type.from != "CDR3", 0,
                         ifelse(pos.from > 2 & pos.from < cdr.len - 4, 1, 0))) %>% 
  group_by(residue.aa.from) %>% 
  summarise(total.from.mean = sum(n.mean),
            total.from.flat = sum(n.flat))
```

### Calc expected contact frequencies

```{r}
contacts.total.sym <- contacts.total.from %>% 
  rbind(contacts.total.to %>% rename(residue.aa.from = residue.aa.to, 
                                     total.from.mean = total.to.mean, 
                                     total.from.flat = total.to.flat)) %>% 
  group_by(residue.aa.from) %>% 
  summarise(total.from.mean = sum(total.from.mean),
         total.from.flat = sum(total.from.flat)) 

contacts.total.mean.flat <- 
  rbind(
    expand.grid(residue.aa.from = contacts.total.from$residue.aa.from,
                residue.aa.to = contacts.total.to$residue.aa.to) %>% 
      merge(contacts.total.from) %>% 
      merge(contacts.total.to) %>% 
      mutate(type.1 = "cdrpa"),
    
    expand.grid(residue.aa.from = contacts.total.from$residue.aa.from,
                residue.aa.to = contacts.total.to$residue.aa.to) %>% 
      merge(contacts.total.sym) %>% 
      merge(contacts.total.sym %>% rename(residue.aa.to = residue.aa.from, 
                                          total.to.mean = total.from.mean, 
                                          total.to.flat = total.from.flat)) %>% 
      mutate(type.1 = "cdrps")
  ) %>% 
    melt(id = c("type.1", "residue.aa.to", "residue.aa.from")) %>% 
    mutate(value = value + 1) %>% 
    dcast(type.1 + residue.aa.to + residue.aa.from ~ variable) %>% 
    mutate(exp.mean = total.from.mean * total.to.mean,
           exp.flat = total.from.flat * total.to.flat,
           freq.exp.mean = exp.mean / sum(exp.mean),
           freq.exp.flat = exp.flat / sum(exp.flat))
```

### Calc potential with "mean" and "flat" normalization
```{r}
tcren.mean.flat <- compute_TCRen(pdb.nonred, "70") %>% 
  select(residue.aa.from, residue.aa.to, cdrpa.nonsym.70, cdrpa.70, cdrps.70) %>% 
  merge(
  contacts.a.new %>% 
    filter(pdb.id %in% pdb.nonred) %>% 
    compute_TCRen_count(.suf = "norm") %>% 
    merge.data.frame(expand.grid(residue.aa.from = aa.levels, residue.aa.to = aa.levels, type = .$type %>% unique()), all.y = T) %>% 
    mutate(count = replace_na(count, 0),
           count = count + 1/20,
           freq = count / sum(count),
           type.1 = str_split_fixed(type, "\\.", 2)[,1]) %>% 
    merge(contacts.total.mean.flat) %>% 
    mutate(odds.mean = log(freq / freq.exp.mean),
           odds.flat = log(freq / freq.exp.flat)) %>% 
    #filter(residue.aa.to == "C",
    #       type == "cdrpa.nonsym.norm")
    #select(type, residue.aa.from, residue.aa.to, odds.mean, odds.flat) %>% 
    mutate(type = str_split_fixed(type, "_", 2)[,1]) %>% 
    group_by(type, residue.aa.from, residue.aa.to) %>% 
    summarise(odds.mean = mean(odds.mean),
              odds.flat = mean(odds.flat)) %>% 
    melt(id = c("type", "residue.aa.from", "residue.aa.to")) %>% 
    mutate(type = paste0(type, str_split_fixed(variable, "\\.", 2)[,2])) %>% 
    select(type, residue.aa.from, residue.aa.to, value) %>% 
    dcast(residue.aa.from + residue.aa.to ~ type)
  ) %>% 
  #merge(compute_TCRen(pdb.nonred, "70")) %>% 
  merge.data.frame(fread("~/struct2020/TCRen_MJ.csv") %>% 
                     select(residue.aa.from, residue.aa.to, mj, mj2) %>% 
                   mutate(mj = -mj, mj2 = -mj2) #!!!
                   ) %>% 
  merge(fread("~/struct2020/contacts_a_f_s_mi.csv") %>% 
          filter(type %in% c("cdrps.70", "cdrpa.nonsym.70")) %>% 
          mutate(mi = count / total * odds,
                 type = paste0("mi.", type)) %>% 
          select(type, residue.aa.from, residue.aa.to, mi) %>% 
          dcast(residue.aa.from + residue.aa.to ~ type))

tcren.mean.flat %>% 
  melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential") %>% 
  filter(potential %in% c("cdrps.70", "cdrps.normmean", "cdrps.normflat")) %>% 
  ggplot(aes(x = value, color = potential)) +
  geom_density() +
  theme_bw()

tcren.mean.flat %>% 
  #filter(type == "cdrps.norm") %>% 
  ggplot(aes(x = cdrps.normmean, y = cdrps.70)) +
  geom_smooth(method = "lm") +
  #geom_abline(intercept = 0, slope = 1, color = 'red') +
  geom_point(size = .5) +
  theme_bw()

library(corrplot)
tcren.mean.flat %>% 
  .[,-c(1,2)] %>% 
  cor %>% 
  corrplot(method = 'number', number.cex=0.6)
  round(2)
```

```{r}
compute_TCRen(pdb.nonred, "")
test.odds <- fread("~/struct2020/contacts_a_s.csv") %>%
  filter(type == "cdrps") %>% 
  select(residue.aa.from, residue.aa.to, count, total.from, total.to, total, odds) %>% 
  mutate(freq = count / total,
         freq.exp = total.from * total.to / total / total,
         odds.1 = log(freq / freq.exp),
         odds.old = log(count * total / total.to / total.from),
         exp.2 = total.from * total.to,
         freq.exp.2 = exp.2 / sum(exp.2),
         odds.2 = log(freq / freq.exp.2),
         dif = odds - odds.old)

test.odds %>% 
  ggplot(aes(x = odds.1, y = odds.2)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)

test.odds %>% 
  ggplot(aes(x = odds, y = odds.2)) +
  geom_point()

test.odds %>% 
  select(residue.aa.from, residue.aa.to, odds, odds.2) %>% 
  melt(id = c("residue.aa.from", "residue.aa.to")) %>% 
  ggplot(aes(x = value, color = variable)) +
  geom_density()
```


## New and old PDBs

```{r}
pdb.new_old <-
  fread("~/shared-with-me/struct2020/benchmark/new_PDBs/old_PDBs.txt", 
        header = F, col.names = "pdb.id") %>% 
  mutate(group = "old") %>% 
  rbind(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/new_PDBs.txt", 
              header = F, col.names = "pdb.id") %>% 
          mutate(group = "new"))
```

### Rare contacts in new structures
```{r}
merge(
fread("~/struct2020/contacts_a_s.csv") %>% filter(type == "cdrps") %>% select(residue.aa.from, residue.aa.to, count.old = count),
compute_TCRen_count(contacts.a.new, "") %>% ungroup %>% filter(type == "cdrps.") %>% select(residue.aa.from, residue.aa.to, count.new = count)
) %>% 
  filter(count.old < 50) %>% 
  ggplot(aes(x = count.old, y = count.new)) +
  geom_abline(intercept = 0, slope = 1, color = 'red') +
  geom_point(size = .5) +
  theme_bw()
```

## Cluster PDBs based on Manhattan dist between contact maps (vectors of length 400)

```{r, fig.width=20}
pdb.contacts.dist <- contacts.a.new %>% 
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE") %>% 
  group_by(pdb.id, residue.aa.to, residue.aa.from) %>% 
  summarise(n = n()) %>% 
  merge(expand.grid(pdb.id = unique(contacts.a.new$pdb.id), 
                    residue.aa.to = unique(contacts.a.new$residue.aa.to),
                    residue.aa.from = unique(contacts.a.new$residue.aa.to)), 
        all.y = T) %>% 
  filter(pdb.id %in% mhc.classes$pdb.id) %>% 
  mutate(n = replace_na(n, 0),
         contact = paste0(residue.aa.from, residue.aa.to)) %>% 
  select(pdb.id, contact, n) %>% 
  dcast(pdb.id ~ contact) %>% 
  column_to_rownames("pdb.id") %>% 
  dist(method = "manhattan")

qplot(pdb.contacts.dist, binwidth = 1)

pdb.contacts.dist.a <- pdb.contacts.dist %>% 
  as.matrix() %>% 
  melt(value.name = "dist.manh") %>% 
  rename(pdb.id.from = Var1, pdb.id.to = Var2) %>% 
  merge(pdb.contacts %>% select(pdb.id.from = pdb.id, n.from = n)) %>% 
  merge(pdb.contacts %>% select(pdb.id.to = pdb.id, n.to = n)) %>% 
  mutate(dist = dist.manh / (n.from + n.to))

#q <- pdb.contacts.dist.a %>% 
#  merge(pdb.pairs)

pdb.clusters <- hclust(pdb.contacts.dist.a %>% select(pdb.id.from, pdb.id.to, dist) %>% dcast(pdb.id.from ~ pdb.id.to) %>% column_to_rownames("pdb.id.from") %>% as.dist(.))

plot(pdb.clusters, #hang = -1, 
     cex = 0.5) 
```

```{r}
cutree(pdb.clusters, h = 0.5) %>% 
  #max()
  tibble(pdb.id = names(.), cluster = .) %>% 
  merge(pdb.new_old) %>% 
  arrange(cluster, group) %>% 
  group_by(cluster, group) %>% 
  summarise(n = n()) %>% 
  dcast(cluster ~ group) %>% 
  mutate(old = replace_na(old, 0),
         new = replace_na(new, 0)) %>% 
  filter(old == 0)
```

```{r}
library(ggcharts)

for (i in seq(0, 1, by=0.1)) {
  print(paste0("h=", format(round(i, 1), nsmall = 1), "   # clusters  ", cutree(pdb.clusters, h = i) %>% max()))
}

tibble(h = seq(0, 1, by=0.1), n.clusters = seq(0, 1, by=0.1) %>% 
                                      lapply(function(x) {
                                        (cutree(pdb.clusters, h = x) %>% max())
                                      }) %>% 
                                      unlist()
) %>% 
  bar_chart(h, n.clusters) + 
  geom_label(aes(label = n.clusters, hjust = 1.2))
  #ggplot(aes(x = factor(h), y = n.clusters)) +
  #eom_bar(stat = 'identity') +
  #coord_flip() +
  #theme_bw()
```


```{r}
pdb.nonred <- cutree(pdb.clusters, h = 0.7) %>% 
  #max()
  tibble(pdb.id = names(.), cluster = .) %>% 
  arrange(cluster) %>% 
  group_by(cluster) %>% 
  slice(1) %>% 
  .$pdb.id
```

```{r}
markup.new <- read.table("benchmark/new_PDBs/out_mir/markup.txt", fill = T, header = T) %>%
  merge(fread("benchmark/new_PDBs/out_mir/general.txt") %>%
          select(-chain.component, -chain.supertype, -seq.length)) #%>% 
  #filter(pdb.id %in% pdb.mhci)

markup.new.a <- markup.new %>%
    filter(chain.type == "TRA" & region.type == "CDR3") %>%
    select(pdb.id, cdr3a = region.sequence) %>% unique() %>%
  merge(markup.new %>%
    filter(chain.type == "TRB" & region.type == "CDR3") %>%
    select(pdb.id, cdr3b = region.sequence) %>% unique()) %>% 
  merge(markup.new %>%
    filter(chain.type == "PEPTIDE") %>%
    select(pdb.id, peptide = region.sequence) %>% unique()) %>% 
  mutate(cdr3a.length = nchar(cdr3a), cdr3b.length = nchar(cdr3b),
         peptide.length = nchar(peptide)) #%>% 
  #filter(peptide.length < 14)
```

AA composition of peptides and CDR3 in nonred database
```{r}
aa.levels <- c("L","F","I","M","V","W","Y","C","H","A","G","P","T","S","Q","N","D","E","R","K")

pdb.nonred.markup <- markup.new.a %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  mutate(cdr3a.tr = substr(cdr3a, 4, nchar(cdr3a) - 3),
         cdr3b.tr = substr(cdr3b, 4, nchar(cdr3a) - 3)) %>% 
  group_by(peptide) %>% 
  mutate(n = n()) %>% 
  arrange(-n)
  
paste0(pdb.nonred.markup$peptide, collapse = "") %>% 
  strsplit(split="") %>% unlist() %>% 
  table() %>% as_tibble() %>% 
  rename(aminoacid = '.') %>%
  mutate(type = "peptide") %>% 
  rbind(paste0(c(pdb.nonred.markup$cdr3a.tr, pdb.nonred.markup$cdr3b.tr), collapse = "") %>% 
          strsplit(split="") %>% unlist() %>% 
          table() %>% as_tibble() %>% 
          rename(aminoacid = '.') %>%
          mutate(type = "CDR3")) %>% 
  merge(expand.grid(aminoacid = aa.levels, type = unique(.$type)), all.y = T) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  group_by(type) %>% 
  mutate(freq = n / sum(n)) %>%
  select(-n) %>% 
  rbind(
      tibble(type = c(rep("General protein-protein\n interfaces", 20), rep("CDR3 in TCR repertoire", 20)),
                      aminoacid = rep(c("R","K","N","D","Q","E","H","P","Y","W","S","T","G","A","M","C","F","L","V","I"), 2),
                      freq = c(c(6, 5.3, 4.5, 5.6, 4.4, 6.2, 2.5, 4.7, 4.6, 1.8, 6.2, 6, 6.6, 6.5, 2.2, 1.8, 4.2, 8.2, 6, 5),
                               c(6.5, 1.1, 6.4, 5.4, 5.5, 4.4, 0.9, 4.9, 5.6, 1.0, 8.9, 8.3, 20.9, 6.1, 0.6, 0.0, 1.7, 6.7, 3.6, 1.4))) %>% 
      mutate(freq = freq / 100)
  ) %>% 
  #filter(type %in% c("CDR3", "peptide")) %>% 
  ggplot(aes(x = factor(aminoacid, levels = aa.levels), color = type, group = type, y = freq)) +
  geom_line() +
  theme_bw()
```


## Multiple PDB peptide mutation benchmark

Select PDBs for peptide mutation benchmark
```{r}
#select 1 PDB from each cluster (only MHC class I as for MHC II register issues exist)
pdb.benchmark <- cutree(pdb.clusters, h = 0.7) %>% 
  tibble(pdb.id = names(.), cluster = .) %>% 
  filter(pdb.id %in% pdb.mhci) %>% 
  merge(mhc.classes) %>% 
  group_by(cluster) %>% 
  slice(1)

pdb.benchmark %>% 
  group_by(mhc.allele, pep.length) %>% 
  summarise(n = n()) %>% 
  group_by(mhc.allele) %>% 
  summarise(n = sum(n)) %>% 
  arrange(-n)
```

```{r}
iedb.a <- iedb %>%
  mutate(pep.length = nchar(as.character(Epitope.2))) %>%
  filter(Epitope.1 == "Linear peptide", 
         Assay.5 != "Negative") %>% 
  select(iedb.peptide = Epitope.2, MHC, pep.length) %>% 
  distinct()

pdb.benchmark.a <- pdb.benchmark %>% 
  #filter(!mhc.allele %in% c("HLA-E", "HLA-B37")) %>% 
  merge(iedb.a %>% 
          mutate(MHC.short = str_split_fixed(gsub("\\*", "", MHC), ":", 2)[,1],
                 MHC.short = ifelse(substr(MHC.short, 6, 6) == "0", gsub("0", "", MHC.short), MHC.short),
                 MHC.short = gsub("H2-", "H-2", MHC.short)) %>% 
          group_by(MHC, MHC.short) %>% 
          summarise(n = n()) %>% 
          group_by(MHC.short) %>% 
          arrange(MHC.short, -n) %>% 
          slice(1) %>% 
          select(mhc.allele = MHC.short, MHC, n) %>% 
          filter(n > 100)) #%>% 
  #group_by(mhc.allele) %>% 
  #summarise(n = n()) %>% 
  #arrange(-n)
  
pdb.benchmark.peptides <- pdb.benchmark.a %>% 
  merge(iedb.a %>% 
          filter(MHC %in% pdb.benchmark.a$MHC)) %>% 
  filter(substr(peptide, 2, 2) == substr(iedb.peptide, 2, 2),
         substr(peptide, nchar(peptide), nchar(peptide)) == substr(iedb.peptide, nchar(iedb.peptide), nchar(iedb.peptide)),
         stringdist(peptide, iedb.peptide) == nchar(peptide) - 2)

pdb.benchmark.peptides %>% 
  group_by(pdb.id, MHC, pep.length) %>% 
  summarise(n = n()) %>% 
  arrange(-n)

pdb.benchmark.peptides.1000 <- pdb.benchmark.peptides %>% 
  filter(n > 10) %>% 
  group_by(pdb.id, MHC, pep.length) %>%
  sample_n(min(1000, n())) %>%
  ungroup() %>% 
  select(pdb.id, iedb.peptide) 

for (pdb in unique(pdb.benchmark.peptides.1000$pdb.id)) {
  pdb.benchmark.peptides.1000 %>% 
    filter(pdb.id == pdb) %>% 
    select(iedb.peptide) %>% 
    fwrite(paste0("~/shared-with-me/struct2020/benchmark/mult_pdb/", "iedb_peptides_", substr(pdb, 1, 4)))
}
```

Random seq peptides for benchmark
```{r}
library(stringi)


aa.re <- '[LFIMVWYCHAGPTSQNDERK]'
#peptide <- "ALWGPDPAAA"
#paste0(stri_rand_strings(1, 1, aa.re), substr(peptide, 2, 2), stri_rand_strings(1, nchar(peptide)-3, aa.re), substr(peptide, nchar(peptide), nchar(peptide)))


pdb.benchmark.rand <- pdb.benchmark.a %>% 
  select(pdb.id, peptide, pep.length, MHC) %>% 
  slice(rep(1:n(), each = 10000)) %>% 
  rowwise() %>% 
  mutate(random.peptide = paste0(stri_rand_strings(1, 1, aa.re), substr(peptide, 2, 2), stri_rand_strings(1, nchar(peptide)-3, aa.re), substr(peptide, nchar(peptide), nchar(peptide))))

pdb.benchmark.rand %>% 
  select(allele = MHC, peptide = random.peptide) %>% 
  fwrite("~/shared-with-me/struct2020/benchmark/mult_pdb_random/peptides_all")

pdb.benchmark.rand.flurry <- fread("~/shared-with-me/struct2020/benchmark/mult_pdb_random/mhcflurry_out.csv") %>% 
  filter(mhcflurry_presentation_score > 0.5) %>% 
  merge(pdb.benchmark.rand %>% select(pdb.id, peptide = random.peptide, allele = MHC)) %>% 
  group_by(pdb.id) %>%
  sample_n(min(200, n())) %>%
  ungroup() %>% 
  select(pdb.id, peptide) 

pdb.benchmark.rand.flurry %>% 
  group_by(pdb.id) %>% 
  summarise(n = n())

for (pdb in unique(pdb.benchmark.rand.flurry$pdb.id)) {
  pdb.benchmark.rand.flurry %>% 
    filter(pdb.id == pdb) %>% 
    select(peptide) %>% 
    fwrite(paste0("~/shared-with-me/struct2020/benchmark/mult_pdb_random/", "random_peptides_", substr(pdb, 1, 4)))
}
```

Commands for preproc
```{r}
library(bio3d)

pdb.pep <- general %>% 
  filter(pdb.id %in% pdb.benchmark.peptides.1000$pdb.id) %>% 
  group_by(pdb.id) %>% 
  mutate(chains = paste0(chain.id, collapse = "")) %>% 
  filter(chain.supertype == "PEPTIDE") %>% 
  select(pdb.id, chains, pep.chain = chain.id) %>% 
  ungroup()

pdb.pep %>% mutate(cmd = paste0("clean_pdb ~/shared-with-me/struct2020/", pdb.id, " ", chains)) %>% 
  .$cmd


pdb.pep %>% mutate(cmd = paste0("mv ", substr(pdb.id, 1, 8), "_", chains, ".pdb ", substr(pdb.id, 1, 4), "_c.pdb")) %>% 
  .$cmd  

pdb.pep.start <- pdb.pep$pdb.id %>% 
  lapply(function (xx) {
    paste0("~/shared-with-me/struct2020/benchmark/mult_pdb/", substr(xx, 1, 4), "_c.pdb") %>% 
      read.pdb(.) %>%
      .$atom %>% 
      mutate(pdb = substr(xx, 1, 4)) 
  }) %>% 
  rbindlist() %>% 
  merge(pdb.pep %>% 
          mutate(pdb = substr(pdb.id, 1, 4)) %>% select(pdb, chain = pep.chain)) %>% 
  group_by(pdb, chain) %>% 
  arrange(resno) %>% 
  slice(1) %>% 
  select(pdb, pep.start = resno)

pdb.pep.start %>% 
  mutate(cmd = paste0("python3 ../fixbb.py -in iedb_peptides_", pdb, " -start ",  pep.start, " -pdb ", pdb, "_c.pdb &> log_", pdb, " &")) %>% 
  .$cmd

pdb.pep.start %>% 
  mutate(cmd = paste0("python3 ../fixbb.py -in random_peptides_", pdb, " -start ",  pep.start, " -pdb ", pdb, "_c.pdb &> log_", pdb, " &")) %>% 
  .$cmd
```

```{r}
#mult_pdb.contacts <- df_contacts("benchmark/mult_pdb/out_mir/")

mult_pdb.energy <- mult_pdb.contacts %>% 
  mutate(group = ifelse(substr(pdb.id, nchar(pdb.id)-5, nchar(pdb.id)) == "_c.pdb", T, F)) %>% 
  merge.data.frame(potentials) %>% 
  group_by(pdb.id, group) %>% 
  summarise_TCRen_MJ()  

mult_pdb.energy.a <- mult_pdb.energy %>% 
  melt(id = c("pdb.id", "group"), variable.name = "potential") 

mult_pdb.energy.a %>% 
  plot_roc_curve()

mult_pdb.energy.a %>% 
  plot_potentials()

mult_pdb.energy.a %>% 
  calc_roc_auc()


pdb.benchmark.peptides.1000 %>% 
  group_by(pdb.id) %>% 
  summarise(n = n())
  
mult_pdb.energy.rank <- mult_pdb.energy.a %>% 
  mutate(pdb = substr(pdb.id, 1, 4)) %>% 
  merge(pdb.benchmark.peptides.1000 %>% 
          mutate(pdb = substr(pdb.id, 1, 4)) %>% 
          group_by(pdb) %>% 
          summarise(n = n())) %>% 
  group_by(pdb, potential) %>% 
  mutate(value.rank = rank(value) / n()) %>% 
  filter(group == T) 

mult_pdb.energy.rank %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = potential, y = value.rank, size = n)) +
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  theme_bw()

mult_pdb.energy.rank %>% 
  ggplot(aes(x = value.rank, color = potential)) +
  stat_ecdf() +
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  theme_bw()

```

```{r}
#mult_pdb_rand.contacts <- df_contacts("benchmark/mult_pdb_random/out_mir/")

mult_pdb_rand.energy <- mult_pdb_rand.contacts %>% 
  mutate(group = ifelse(substr(pdb.id, nchar(pdb.id)-5, nchar(pdb.id)) == "_c.pdb", T, F)) %>% 
  merge.data.frame(potentials) %>% 
  group_by(pdb.id, group) %>% 
  summarise_TCRen_MJ()  

mult_pdb_rand.energy.a <- mult_pdb_rand.energy %>% 
  melt(id = c("pdb.id", "group"), variable.name = "potential") 

mult_pdb_rand.pdb <- mult_pdb_rand.energy.a %>% 
  select(pdb.id) %>% 
  distinct() %>% 
  mutate(pdb = substr(pdb.id, 1, 4)) %>% 
  group_by(pdb) %>% 
  summarise(n = n()) %>% 
  filter(n > 10) %>% 
  .$pdb

mult_pdb_rand.energy.a <- mult_pdb_rand.energy.a %>% 
  filter(substr(pdb.id, 1, 4) %in% mult_pdb_rand.pdb)

mult_pdb_rand.energy.a %>% 
  plot_roc_curve()

mult_pdb_rand.energy.a %>% 
  plot_potentials()

mult_pdb_rand.energy.a %>% 
  calc_roc_auc()

mult_pdb_rand.energy.rank <- mult_pdb_rand.energy.a %>% 
  mutate(pdb = substr(pdb.id, 1, 4)) %>% 
  group_by(pdb, potential) %>% 
  mutate(value.rank = rank(value) / n()) %>% 
  filter(group == T) 

mult_pdb_rand.energy.rank %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  theme_bw()

mult_pdb_rand.energy.rank %>% 
  ggplot(aes(x = value.rank, color = potential)) +
  stat_ecdf() +
  geom_abline(intercept = 0, slope = 1, linetype="dashed") +
  theme_bw()

```

Explore different ways to calc odds
```{r}
contacts.a.s %>% 
  select(type, residue.aa.from, residue.aa.to, odds) %>% 
  dcast(residue.aa.from + residue.aa.to ~ type) %>% 
  ggplot(aes(x = cdrpa, y = cdrps)) +
  geom_point() +
  geom_smooth(method = 'lm')
```


```{r}
contacts.a.s.1 %>% 
  filter(type == "cdrpa") %>% 
  select(residue.aa.from, residue.aa.to, odds.1 = odds) %>% 
  merge(contacts.a.s.1 %>% 
          filter(type == "cdrpa") %>% 
          select(residue.aa.to = residue.aa.from, residue.aa.from = residue.aa.to, odds.2 = odds)) %>% filter(residue.aa.from != residue.aa.to) %>% 
  ggplot(aes(x = odds.1, y = odds.2)) +
  geom_point() +
  geom_smooth(method = 'lm')
```

```{r}
contacts.cdrpa <- contacts.a.x %>% 
  filter(type == "cdrpa") %>% 
  select(residue.aa.from, residue.aa.to, count) %>% 
  #filter(residue.aa.from != "C",
  #       residue.aa.to != "C") %>% 
  group_by(residue.aa.from) %>%
  mutate(total.from = sum(count)) %>%
  group_by(residue.aa.from) %>%
  mutate(total.to = sum(count)) %>%
  ungroup %>%
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from))

contacts.cdrpa.noC <- contacts.a.x %>% 
  filter(type == "cdrpa") %>% 
  select(residue.aa.from, residue.aa.to, count) %>% 
  filter(residue.aa.from != "C",
         residue.aa.to != "C") %>% 
  group_by(residue.aa.from) %>%
  mutate(total.from = sum(count)) %>%
  group_by(residue.aa.from) %>%
  mutate(total.to = sum(count)) %>%
  ungroup %>%
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from))

contacts.cdrpa %>% 
  select(residue.aa.from, residue.aa.to, odds.cdrpa = odds) %>% 
  merge(contacts.cdrpa.noC %>% 
          select(residue.aa.from, residue.aa.to, odds.cdrpa.noC = odds)) %>% 
  ggplot(aes(x = odds.cdrpa, y = odds.cdrpa.noC)) +
  geom_point() +
  geom_smooth(method = "lm")


contacts.a.s.2 %>% 
  filter(count == 1)


contacts.a.s.1 %>% 
  filter(type == "cdrpa")
```




## Compute potential based only on CDR3 contacts
```{r}
contacts.a.cdr3 <- rbind(
  contacts.a %>%
  filter(startsWith(region.type.from, "CDR3") & region.type.to == "PEPTIDE" | 
           startsWith(region.type.to, "CDR3") & region.type.from == "PEPTIDE") %>%
  group_by(type = "cdrps.cdr3", residue.aa.from, residue.aa.to) %>%
  summarize(count = n()),
  
  contacts.a %>%
  filter(startsWith(region.type.from, "CDR3") & region.type.to == "PEPTIDE") %>%
  group_by(type = "cdrpa.cdr3.nonsym", residue.aa.from, residue.aa.to) %>%
  summarize(count = n()),
  
  contacts.a %>%
  filter(startsWith(region.type.from, "CDR3") & region.type.to == "PEPTIDE") %>%
  group_by(type = "cdrpa.cdr3.1", residue.aa.from, residue.aa.to) %>%
  summarize(count = n()),
  
  contacts.a %>%
  filter(startsWith(region.type.to, "CDR3") & region.type.from == "PEPTIDE") %>%
  group_by(type = "cdrpa.cdr3.2", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())
)


contacts.a.s.cdr3 <- expand.grid(type = contacts.a.cdr3$type %>% unique(),
                                 residue.aa.from = contacts.a.cdr3$residue.aa.from %>% unique(),
                                 residue.aa.to = contacts.a.cdr3$residue.aa.from %>% unique()) %>%
  merge(contacts.a.cdr3, all = T) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  mutate(count = count + 1) %>% 
  group_by(type, residue.aa.from) %>%
  mutate(total.from = sum(count)) %>%
  group_by(type, residue.aa.to) %>%
  mutate(total.to = sum(count)) %>%
  ungroup %>%
  group_by(type) %>%
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from)) %>% 
  select(type, residue.aa.from, residue.aa.to, odds) %>% 
  mutate(type = ifelse(type %in% c("cdrpa.cdr3.1", "cdrpa.cdr3.2"), "cdrpa.cdr3", type %>% as.character())) %>% 
  group_by(type, residue.aa.from, residue.aa.to) %>%
  summarise(odds = mean(odds))

```

## Compute potential for a non-redundant subset of PDBs

### Function for calc of cdrpa/cdrps/cdrpa.nonsym based on given list of PDBs 
```{r}
compute_TCRen_count <- function(contacts.a.f, .suf, .region = "CDR") {
  rbind(
    contacts.a.f %>%
    filter(startsWith(region.type.from, .region) & region.type.to == "PEPTIDE" | 
             startsWith(region.type.to, .region) & region.type.from == "PEPTIDE") %>%
    group_by(type = paste0("cdrps.", .suf), residue.aa.from, residue.aa.to) %>%
    summarize(count = n()),
    
    contacts.a.f %>%
    filter(startsWith(region.type.from, .region) & region.type.to == "PEPTIDE") %>%
    group_by(type = paste0("cdrpa.nonsym.", .suf), residue.aa.from, residue.aa.to) %>%
    summarize(count = n()),
    
    contacts.a.f %>%
    filter(startsWith(region.type.from, .region) & region.type.to == "PEPTIDE") %>%
    group_by(type = paste0("cdrpa.", .suf, "_1"), residue.aa.from, residue.aa.to) %>%
    summarize(count = n()),
    
    contacts.a.f %>%
    filter(startsWith(region.type.to, .region) & region.type.from == "PEPTIDE") %>%
    group_by(type = paste0("cdrpa.", .suf, "_2"), residue.aa.from, residue.aa.to) %>%
    summarize(count = n())
  )
}


compute_TCRen <- function(.pdb.list, .suf, .region = "CDR") {

  contacts.a.f <- contacts.a.new %>% 
    filter(pdb.id %in% .pdb.list)
  
  contacts.a.f.x <- compute_TCRen_count(contacts.a.f, .suf, .region = "CDR")

  contacts.a.f.s <- 
    expand.grid(type = contacts.a.f.x$type %>% unique(),
                                   residue.aa.from = contacts.a.f.x$residue.aa.from %>% unique(),
                                   residue.aa.to = contacts.a.f.x$residue.aa.from %>% unique()) %>%
    merge(contacts.a.f.x, all = T) %>%
    mutate(count = ifelse(is.na(count), 0, count)) %>%
    mutate(count = count + 1) %>% 
    #mutate(count = ifelse(is.na(count), 0.1, count)) %>%
    group_by(type, residue.aa.from) %>%
    mutate(total.from = sum(count)) %>%
    group_by(type, residue.aa.to) %>%
    mutate(total.to = sum(count)) %>%
    ungroup %>%
    group_by(type) %>%
    mutate(total = sum(count)) %>%
    ungroup %>%
    mutate(odds = log(count * total / total.to / total.from)) %>% 
    select(type, residue.aa.from, residue.aa.to, odds) %>% 
    mutate(type = str_split_fixed(type, "_", 2)[,1]) %>% 
    group_by(type, residue.aa.from, residue.aa.to) %>%
    summarise(odds = mean(odds))

  contacts.a.f.s %>% 
    dcast(residue.aa.from + residue.aa.to ~ type)
}
```

## Pseudocount 1 or 0.1, use C or not
```{r}
#q <- compute_TCRen(pdb_nonred_list(.7), "plus1")
#q1 <- compute_TCRen(pdb_nonred_list(.7), "plus0.1")

q %>% 
  select(residue.aa.from, residue.aa.to, cdrps.plus1) %>% 
  merge(q1 %>% select(residue.aa.from, residue.aa.to, cdrps.plus0.1)) %>% 
  filter(as.character(residue.aa.from) > as.character(residue.aa.to)) %>% 
  melt(id = c("residue.aa.from", "residue.aa.to")) %>% 
  ggplot(aes(x = value, color = variable)) +
  geom_density()
  #mutate(dif = cdrps.plus1 - cdrps.plus0.1) %>% 
  #arrange(dif) %>% 
  ggplot(aes(x = cdrps.plus1, y = cdrps.plus0.1)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)
  geom_smooth()
  
pot.pseudocount.noC <- q %>% 
  select(residue.aa.from, residue.aa.to, cdrps.plus1) %>% 
  merge(q1 %>% select(residue.aa.from, residue.aa.to, cdrps.plus0.1)) %>%
  merge(q %>% 
          select(residue.aa.from, residue.aa.to, cdrps.plus1.noC = cdrps.plus1) %>% 
          merge(q1 %>% select(residue.aa.from, residue.aa.to, cdrps.plus0.1.noC = cdrps.plus0.1)) %>%
          filter(residue.aa.from != "C", residue.aa.to != "C"), all = T) %>%
  mutate(cdrps.plus0.1.noC = replace_na(cdrps.plus0.1.noC, 0),
         cdrps.plus1.noC = replace_na(cdrps.plus1.noC, 0)) 

pot.pseudocount.noC %>% 
  group_by(residue.aa.from) %>% 
  summarise(cdrps.plus1.mean = mean(cdrps.plus1),
            cdrps.plus0.1.mean = mean(cdrps.plus0.1),
            cdrps.plus1.noC.mean = mean(cdrps.plus1.noC),
            cdrps.plus0.1.noC.mean = mean(cdrps.plus0.1.noC)) %>% 
  melt(id = "residue.aa.from") %>%
  ggplot(aes(x = residue.aa.from, y = value, color = variable, group = variable)) +
  geom_line() +
  theme_bw()
  #geom_bar(stat = "identity")
  
```


```{r}
pdb_nonred_list <- function(h, groups = c("new", "old")) {
  cutree(pdb.clusters, h = h) %>% 
    tibble(pdb.id = names(.), cluster = .) %>% 
    merge(pdb.new_old) %>% 
    filter(group %in% groups) %>% 
    arrange(cluster) %>% 
    group_by(cluster) %>% 
    slice(1) %>% 
    .$pdb.id
}

compute_TCRen(pdb.new_old %>% filter(group == "old") %>% .$pdb.id, "old") %>% 
  merge(potentials) %>% 
  .[,-c(1,2)] %>% 
  cor

compute_TCRen(pdb.new_old %>% filter(group == "old") %>% .$pdb.id, "old") %>% 
  merge(compute_TCRen(pdb.nonred, "70")) %>% 
  select(cdrps.old, cdrps.70, cdrpa.old, cdrpa.70, cdrpa.nonsym.old, cdrpa.nonsym.70) %>% 
  cor %>% 
  cor_plot(method = "number")

compute_TCRen(pdb_nonred_list(.7), "70new") %>% 
  merge(compute_TCRen(pdb_nonred_list(.7, "old"), "70old")) %>% 
  select(cdrps.70new, cdrps.70old, cdrpa.70new, cdrpa.70old, cdrpa.nonsym.70new, cdrpa.nonsym.70old) %>% 
  cor %>% 
  cor_plot(method = "number")
  
```

## Contacts for CDR1/2 and CDR3 with peptide and MHC (?)
```{r}
contacts.cdr123 <- contacts.a.new %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  filter(chain.supertype.from == "TRAB",
         chain.supertype.to %in% c("MHCI", "MHCII", "PEPTIDE")) 

contacts.cdr123 %>% 
  group_by(chain.supertype.to, residue.aa.from, residue.aa.to) %>% 
  summarise(n = n()) %>% 
  dcast(residue.aa.from + residue.aa.to ~ chain.supertype.to) %>% 
  replace(is.na(.), 0) %>% 
  ggplot(aes(x = MHCI, y = PEPTIDE)) +
  geom_point()
  
  group_by(region.type.from, chain.supertype.to, residue.aa.from, residue.aa.to) %>% 
  summarise(n = n()) %>% 
  ungroup %>% 
  select(region.type.from, chain.supertype.to) %>% 
  distinct()
```


## Normalization of TCRen for AA freq for AAs which have at least 1 contact in the given structure
```{r}
.region = "CDR"

count.total <- contacts.a.new %>% 
  filter(pdb.id %in% pdb_nonred_list(.7, "old")) %>% 
  filter(startsWith(region.type.from, .region) & region.type.to == "PEPTIDE" | 
             startsWith(region.type.to, .region) & region.type.from == "PEPTIDE") %>% 
  select(pdb.id, chain.supertype.from, chain.id.from, residue.index.from, residue.aa.from) %>% 
  distinct() %>% 
  group_by(chain.supertype.from, residue.aa.from) %>% 
  summarise(n = n()) %>% 
  merge(expand.grid(chain.supertype.from = .$chain.supertype.from %>% unique(),
                    residue.aa.from = .$residue.aa.from %>% unique()), all.y = T) %>% 
  mutate(n = replace_na(n, 0)) 

count.total.a <- count.total %>% 
  filter(chain.supertype.from == "TRAB") %>% 
  select(-chain.supertype.from, total.from = n) %>% 
  merge(count.total %>% 
          filter(chain.supertype.from == "PEPTIDE") %>% 
          select(-chain.supertype.from, total.to = n)) %>% 
  mutate(type.1 = "cdrpa") %>% 
  rbind(count.total %>% 
          group_by(residue.aa.from) %>% 
          summarise(total.from = sum(n)) %>% 
          mutate(total.to = total.from,
                 type.1 = "cdrps")) %>% 
  mutate(residue.aa.to = residue.aa.from)
```

```{r}
pot.count <- contacts.a.new %>% 
  filter(pdb.id %in% pdb_nonred_list(.7, "old")) %>% 
  compute_TCRen_count("count") %>% 
  merge(expand.grid(type = .$type %>% unique(),
        residue.aa.from = .$residue.aa.from %>% unique(),
        residue.aa.to = .$residue.aa.from %>% unique()), all = T) %>% 
  mutate(type.1 = str_split_fixed(type, "\\.", 2)[,1]) %>% 
  merge(count.total.a %>% select(type.1, residue.aa.from, total.from)) %>% 
  merge(count.total.a %>% select(type.1, residue.aa.to, total.to)) %>% 
  #filter(count > total.to) %>% 
  select(-type.1) %>%  
  mutate(count = replace_na(count, 0)) %>%
  mutate(count = count + 1/20,
         total.to = total.to + 1,
         total.from = total.from + 1) %>% 
  group_by(type) %>%
  #summarise(total.from.s = sum(total.from),
  #          total.to.s = sum(total.to),
  #          count.s = sum(count))
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from)) %>% 
  select(type, residue.aa.from, residue.aa.to, odds) %>% 
  mutate(type = str_split_fixed(type, "_", 2)[,1]) %>% 
  group_by(type, residue.aa.from, residue.aa.to) %>%
  summarise(odds = mean(odds)) %>%  
  group_by(type) %>% 
  mutate(odds = odds - median(odds)) %>% 
  dcast(residue.aa.from + residue.aa.to ~ type)

compute_TCRen(pdb.nonred, "70") %>% 
  merge(pot.count) %>% 
  select(-residue.aa.from, -residue.aa.to) %>% 
  cor

pot.count$cdrpa.count %>% qplot()
```

## in silico peptide mutation with preservance of contact map

### Function
```{r}
pep_mut <- function(pdb.list, df.peptides, potentials, df = contacts.a.new) {
  
  max.pep.len <- max(nchar(df.peptides$peptide))
  
  df %>% 
    filter(pdb.id %in% pdb.list,
           chain.supertype.from == "TRAB",
           chain.supertype.to == "PEPTIDE") %>% 
    select(pdb.id, chain.type.from, region.type.from, residue.index.from, residue.index.to, residue.aa.from) %>%
    merge(df.peptides %>% 
            separate(peptide, into = as.character(0:(max.pep.len - 1)), sep = 1:max.pep.len, remove = F) %>% 
            melt(id = colnames(df.peptides), variable.name = "residue.index.to", value.name = "residue.aa.to") %>% 
            filter(residue.aa.to != "") %>% 
            mutate(residue.index.to = as.integer(as.character(residue.index.to))),
          allow.cartesian=TRUE) %>% 
    merge.data.frame(potentials %>% 
                       melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")) %>% 
    group_by(pdb.id, peptide, potential) %>% 
    summarise(pot.value = -sum(value)) %>% 
    merge.data.frame(df.peptides)

}

pep_mut("6am5_al2.pdb", dmf5.peptides %>% mutate(pdb.id = "6am5_al2.pdb"), tcren.mean.flat) %>% 
  mutate(group = group == "GIG",
         value = pot.value) %>% 
  plot_roc_curve()

pep_mut("6am5_al2.pdb", dmf5.peptides %>% mutate(pdb.id = "6am5_al2.pdb"), tcren.mean.flat) %>% 
  mutate(group = group == "GIG",
         value = pot.value) %>% 
  calc_roc_auc()

pep_mut("6amu_al2.pdb", dmf5.peptides %>% mutate(pdb.id = "6amu_al2.pdb"), tcren.mean.flat) %>% 
  mutate(group = group == "DRG",
         value = pot.value) %>% 
  plot_roc_curve()

pep_mut("6amu_al2.pdb", dmf5.peptides %>% mutate(pdb.id = "6amu_al2.pdb"), tcren.mean.flat) %>% 
  mutate(group = group == "DRG",
         value = pot.value) %>% 
  calc_roc_auc()

pep_mut("6bj3_al2.pdb", tcr55.peptides %>% mutate(pdb.id = "6bj3_al2.pdb"), tcren.mean.flat) %>% 
  mutate(value = pot.value) %>% 
  plot_roc_curve()

pep_mut("6bj3_al2.pdb", tcr55.peptides %>% mutate(pdb.id = "6bj3_al2.pdb"), tcren.mean.flat) %>% 
  mutate(value = pot.value,
         group = group == "recognised") %>% 
  calc_roc_auc()



```

### Peptide shuffling in all complexes
```{r}
pdb.new <- pdb.new_old %>% filter(group == "new") %>% .$pdb.id

mutpep.peptides <- general.new %>% 
  filter(pdb.id %in% pdb.nonred | pdb.id %in% pdb.new,
         chain.supertype == "PEPTIDE") %>% 
  select(pdb.id, peptide.pdb = allele.info) %>% 
  mutate(pep.length = nchar(peptide.pdb)) %>% 
  slice(rep(1:n(), each = 200)) %>% 
  rowwise() %>% 
  mutate(peptide = paste0(stri_rand_strings(1, 1, aa.re), substr(peptide.pdb, 2, 2), stri_rand_strings(1, pep.length-3, aa.re), substr(peptide.pdb, pep.length, pep.length))) %>% 
  select(pdb.id, peptide) %>% 
  mutate(real = F) %>% 
  rbind(general.new %>%
          filter(pdb.id %in% pdb.nonred | pdb.id %in% pdb.new,
                 chain.supertype == "PEPTIDE") %>% 
          select(pdb.id, peptide = allele.info) %>% 
          mutate(real = T))

mutpep.energy <- pep_mut(mutpep.peptides$pdb.id %>% unique(), mutpep.peptides, tcren.mean.flat)
```
Old PDB's
```{r, fig.height=5, fig.width=9}
mutpep.energy %>% 
  filter(!pdb.id %in% pdb.new) %>% 
  merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~mhc.class, ncol = 2)

mutpep.energy %>% 
  filter(!pdb.id %in% pdb.new) %>% 
  merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  calc_roc_auc()

mutpep.energy %>% 
  filter(!pdb.id %in% pdb.new) %>% 
  merge(mhc.classes %>% select(pdb.id, mhc.class)) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  facet_wrap(~mhc.class, ncol = 2) +
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw()
```
New PDB's
```{r}
mutpep.energy %>% 
  filter(pdb.id %in% pdb.new) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() 
#+ facet_wrap(~mhc.class, ncol = 1)

mutpep.energy %>% 
  filter(pdb.id %in% pdb.new) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  calc_roc_auc()

mutpep.energy %>% 
  filter(pdb.id %in% pdb.new) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
#+ facet_wrap(~mhc.class, ncol = 1)
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw()
```
New nonred PDB's
```{r}
mutpep.energy %>% 
  filter(pdb.id %in% pdb.new & pdb.id %in% pdb.nonred) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() 
#+ facet_wrap(~mhc.class, ncol = 1)

mutpep.energy %>% 
  filter(pdb.id %in% pdb.new & pdb.id %in% pdb.nonred) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>%
  mutate(group = real, value = pot.value) %>% 
  calc_roc_auc()

mutpep.energy %>% 
  filter(pdb.id %in% pdb.new & pdb.id %in% pdb.nonred) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
#+ facet_wrap(~mhc.class, ncol = 1)
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw()
```

## VDJdb test
```{r}
vdjdb <- read.csv("benchmark/vdjdb/VDJdb.tsv", sep = '\t')

vdjdb.paired <- vdjdb %>% 
  group_by(complex.id) %>% 
  mutate(n.chains = n()) %>% 
  filter(n.chains == 2) %>% 
  select(complex.id, MHC.class, MHC.A, peptide = Epitope, Gene, CDR3) %>% 
  dcast(complex.id + MHC.class + MHC.A + peptide ~ Gene) %>% 
  mutate(MHC.short = str_split_fixed(gsub("\\*", "", MHC.A), ":", 2)[,1],
         MHC.short = ifelse(substr(MHC.short, 6, 6) == "0", gsub("0", "", MHC.short), MHC.short)) %>% 
  rename(cdr3a = TRA, cdr3b = TRB) %>% 
  select(peptide, MHC.short, cdr3a, cdr3b) %>% 
  mutate(cdr3a.length = nchar(cdr3a),
         cdr3b.length = nchar(cdr3b),
         peptide.length = nchar(peptide)) %>% 
  distinct()


vdjdb.paired %>% 
  group_by(MHC.short) %>% 
  summarise(n = n())

vdjdb.sc <- vdjdb %>% 
  group_by(complex.id) %>% 
  mutate(n.chains = n()) %>% 
  filter(n.chains != 2) %>% 
  ungroup %>% 
  mutate(MHC.short = str_split_fixed(gsub("\\*", "", MHC.A), ":", 2)[,1],
         MHC.short = ifelse(substr(MHC.short, 6, 6) == "0", gsub("0", "", MHC.short), MHC.short)) %>% 
  select(Gene, CDR3, peptide = Epitope, MHC.short)

vdjdb.sc.a <- vdjdb.sc %>% 
  filter(Gene == "TRA") %>% 
  select(peptide, MHC.short, cdr3a = CDR3) %>% 
  merge.data.frame(vdjdb.sc %>%
          filter(Gene == "TRB") %>% 
          select(peptide, MHC.short, cdr3b = CDR3)) %>% 
  distinct() %>% 
  mutate(cdr3a.length = nchar(cdr3a),
         cdr3b.length = nchar(cdr3b),
         peptide.length = nchar(peptide))
  
```
```{r}
vdjdb.benchmark <- markup.new.a %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  #merge.data.frame(mhc.classes %>% select(pdb.id, MHC.short = mhc.allele)) %>%
  #filter(pdb.id %in% pdb_nonred_list(0, "old")) %>% 
  merge(vdjdb.sc.a %>% 
        #vdjdb.paired %>% 
          select(-MHC.short) %>% #! should be commented if MHC is accounted
          rename(cdr3a.vdjdb = cdr3a, cdr3b.vdjdb = cdr3b, peptide.vdjdb = peptide)) %>% 
  mutate(cdr3a.dist = stringdist(cdr3a.vdjdb, cdr3a, method = "hamming"),
         cdr3b.dist = stringdist(cdr3b.vdjdb, cdr3b, method = "hamming"),
         peptide.dist = stringdist(peptide.vdjdb, peptide, method = "hamming")) %>% 
  filter(cdr3a.dist > 3,
         cdr3b.dist > 3,
         peptide.dist > 3) 

vdjdb.benchmark %>% 
  group_by(pdb.id) %>% 
  summarise(n = n()) %>% 
  mutate(total = sum(n)) %>% 
  arrange(-n)

```


```{r}
vdjdb.benchmark.res <- vdjdb.benchmark %>% 
  select(pdb.id, cdr3a.vdjdb, cdr3b.vdjdb) %>% 
  mutate(real = F) %>% 
  rbind(markup.new.a %>% 
          filter(pdb.id %in% (vdjdb.benchmark$pdb.id %>% unique())) %>% 
          select(pdb.id, cdr3a.vdjdb = cdr3a, cdr3b.vdjdb = cdr3b) %>% 
          mutate(real = T)) %>% 
  mutate(region.type.from = "CDR3",
         vdjdb.entry = paste(cdr3a.vdjdb, cdr3b.vdjdb, sep = "_")) %>% 
  melt(id = c("pdb.id", "vdjdb.entry", "real"), variable.name = "chain.type.from", value.name = "cdr3.seq") %>% 
  mutate(chain.type.from = ifelse(chain.type.from == "cdr3a.vdjdb", "TRA", "TRB")) %>% 
  separate(cdr3.seq, into = as.character(0:(max(nchar(.$cdr3.seq)) - 1)), 
           sep = 1:(max(nchar(.$cdr3.seq))), remove = F) %>% 
  melt(id = c("pdb.id", "vdjdb.entry", "real", "chain.type.from", "cdr3.seq"), variable.name = "pos.from", value.name = "residue.aa.from") %>% 
  filter(residue.aa.from != "") %>% 
  mutate(pos.from = as.integer(as.character(pos.from))) %>% 
  select(-cdr3.seq) 

contacts.a.new.tcrp <- contacts.a.new %>% 
  filter(region.type.from == "CDR3",
         chain.supertype.to == "PEPTIDE") %>% 
  merge(resmarkup.a.new %>% 
          filter(region.type == "CDR3") %>% 
          rename(chain.type.from = chain.type) %>% 
          group_by(pdb.id, chain.type.from) %>% 
          summarise(cdr3.start = min(residue.index))) %>% 
  mutate(pos.from = residue.index.from - cdr3.start) 

vdjdb.benchmark.energy <- contacts.a.new.tcrp %>% 
  select(pdb.id, chain.type.from, region.type.from, residue.index.from, residue.index.to, residue.aa.to) %>%
  merge(vdjdb.benchmark.res,
        allow.cartesian=TRUE) %>% 
  merge.data.frame(tcren.mean.flat %>% 
                     melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")) %>% 
  group_by(pdb.id, vdjdb.entry, chain.type.from, real, potential) %>% 
  summarise(pot.value = -sum(value)) 
```
```{r}
vdjdb.benchmark.energy %>% 
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~chain.type.from)

for (chain in c("TRA", "TRB")) {
  print(chain)
  vdjdb.benchmark.energy %>%
    filter(chain.type.from == chain) %>% 
    mutate(group = real, value = pot.value) %>% 
    calc_roc_auc()
}

vdjdb.benchmark.energy %>% 
  group_by(pdb.id, potential, chain.type.from) %>% 
  mutate(n.vdjdb.entries = n()) %>% 
  filter(n.vdjdb.entries > 50) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  facet_wrap(~chain.type.from) +
  geom_quasirandom(size = .5) +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw()


vdjdb.benchmark.energy %>% 
  group_by(pdb.id, vdjdb.entry, real, potential) %>% 
  summarise(pot.value = sum(pot.value)) %>% 
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() 

vdjdb.benchmark.energy %>%
  group_by(pdb.id, vdjdb.entry, real, potential) %>% 
  summarise(pot.value = sum(pot.value)) %>% 
  mutate(group = real, value = pot.value) %>% 
  calc_roc_auc()


vdjdb.benchmark.energy %>% 
  group_by(pdb.id, vdjdb.entry, real, potential) %>% 
  summarise(pot.value = sum(pot.value)) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(n.vdjdb.entries = n()) %>% 
  filter(n.vdjdb.entries > 50) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  geom_quasirandom() +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw()

```
### AA composition of CDR3a and CDR3b
```{r}
vdjdb %>% 
  select(Gene, CDR3) %>% 
  distinct() %>% 
  group_by(Gene) %>% 
  summarise(n = n())

cdr3.aa.comp <- vdjdb %>% 
  select(Gene, CDR3) %>% 
  distinct() %>% 
  mutate(cdr3.tr = substr(CDR3, 5, nchar(CDR3) - 4)) %>% 
  group_by(Gene) %>% 
  summarise(seq = paste0(cdr3.tr, collapse = ""))
          
cdr3.aa.comp %>% 
    filter(Gene == "TRA") %>% 
    .$seq %>% .[1] %>% 
    strsplit(split="") %>% unlist() %>% 
    table() %>% as_tibble() %>% 
    rename(aminoacid = '.') %>%
    mutate(type = "cdr3a") %>% 
  rbind(cdr3.aa.comp %>% 
    filter(Gene == "TRB") %>% 
    .$seq %>% .[1] %>% 
    strsplit(split="") %>% unlist() %>% 
    table() %>% as_tibble() %>% 
    rename(aminoacid = '.') %>%
    mutate(type = "cdr3b")) %>% 
  group_by(type) %>% 
  mutate(freq = n / sum(n)) %>% 
  ggplot(aes(x = factor(aminoacid, levels = aa.levels), y = freq, color = type, group = type)) +
  geom_line() +
  theme_bw()
```
### VDJdb benchmark for separate chains
```{r}
markup.new.a.sc <- markup.new.a %>% 
  select(pdb.id, cdr3a, cdr3b, peptide) %>% 
  merge(mhc.classes %>% select(pdb.id, mhc.allele)) %>% 
  melt(id = c("pdb.id", "peptide", "mhc.allele"), variable.name = "Gene", value.name = "cdr3") %>% 
  mutate(Gene = ifelse(Gene == "cdr3a", "TRA", "TRB"))

vdjdb.benchmark.sc <- vdjdb %>% 
  select(Gene, vdjdb.cdr3 = CDR3, vdjdb.peptide = Epitope, vdjdb.mhc = MHC.A) %>% 
  distinct() %>% 
  mutate(vdjdb.mhc.short = str_split_fixed(gsub("\\*", "", vdjdb.mhc), ":", 2)[,1],
         vdjdb.mhc.short = ifelse(substr(vdjdb.mhc.short, 6, 6) == "0", gsub("0", "", vdjdb.mhc.short), vdjdb.mhc.short)) %>% 
  mutate(cdr3.length = nchar(vdjdb.cdr3),
         peptide.length = nchar(vdjdb.peptide)) %>% 
  merge(markup.new.a.sc %>% 
          mutate(cdr3.length = nchar(cdr3),
                 peptide.length = nchar(peptide))) %>% 
  mutate(cdr3.dist = stringdist(cdr3, vdjdb.cdr3),
         peptide.dist = stringdist(peptide, vdjdb.peptide)) %>% 
  filter(vdjdb.mhc.short == mhc.allele) %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  filter(cdr3.dist > 5,
         peptide.dist > 5) 

vdjdb.benchmark.sc %>% 
  group_by(pdb.id) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  mutate(total = sum(n))
```

```{r}
vdjdb.benchmark.sc.res <- vdjdb.benchmark.sc %>% 
  select(pdb.id, Gene, cdr3 = vdjdb.cdr3) %>% 
  mutate(real = F) %>% 
  rbind(markup.new.a.sc %>% 
          select(pdb.id, Gene, cdr3) %>% 
          merge(vdjdb.benchmark.sc %>% 
                  select(pdb.id, Gene) %>% 
                  unique()) %>% 
          mutate(real = T)) %>%
  rename(chain.type.from = Gene) %>% 
  separate(cdr3, into = as.character(0:(max(nchar(.$cdr3)) - 1)), 
           sep = 1:(max(nchar(.$cdr3))), remove = F) %>% 
  melt(id = c("pdb.id", "real", "chain.type.from", "cdr3"), variable.name = "pos.from", value.name = "residue.aa.from") %>% 
  filter(residue.aa.from != "") %>% 
  mutate(pos.from = as.integer(as.character(pos.from))) 

vdjdb.benchmark.sc.energy <- contacts.a.new.tcrp %>% 
  select(pdb.id, chain.type.from, region.type.from, residue.index.from, residue.index.to, residue.aa.to) %>%
  merge(vdjdb.benchmark.sc.res,
        allow.cartesian=TRUE) %>% 
  distinct() %>% 
  merge.data.frame(tcren.mean.flat %>% 
                     melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")) %>% 
  group_by(pdb.id, chain.type.from, real, cdr3, potential) %>% 
  summarise(pot.value = -sum(value)) 
```
```{r}
vdjdb.benchmark.sc.energy %>% 
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~chain.type.from)

vdjdb.benchmark.sc.energy %>% 
  filter(potential %in% c("cdrpa.70", "cdrps.70", "cdrpa.nonsym.70")) %>%  #%>% #potential == "cdrpa.nonsym.70") %>% 
  ggplot(aes(x = real, y = pot.value)) +
  geom_quasirandom(size = .5) +
  facet_wrap(~chain.type.from + potential, ncol = 3, scales = "free")

for (chain in c("TRA", "TRB")) {
  print(chain)
  vdjdb.benchmark.sc.energy %>%
    filter(chain.type.from == chain) %>% 
    mutate(group = real, value = pot.value) %>% 
    calc_roc_auc()
}

vdjdb.benchmark.sc.energy %>% 
  #filter(pdb.id %in% pdb.list.vdjdb) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(n.vdjdb.entries = n()) %>% 
  filter(n.vdjdb.entries > 50) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  facet_wrap(~chain.type.from) +
  geom_quasirandom(size = .5) +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw() +
  facet_wrap(~chain.type.from)
```
### VDJdb benchmark for separate chains with OLGA data
```{r}
olga <- fread("benchmark/vdjdb/olga_TRA_1000.tsv", header = F) %>% 
  mutate(chain.type.from = "TRA") %>% 
  rbind(fread("benchmark/vdjdb/olga_TRB_1000.tsv", header = F) %>%
          mutate(chain.type.from = "TRB")) %>% 
  select(olga.cdr3 = V2, chain.type.from)

olga.benchmark <- olga %>% 
  distinct() %>% 
  mutate(cdr3.length = nchar(olga.cdr3)) %>% 
  merge(markup.new.a.sc %>% 
          mutate(cdr3.length = nchar(cdr3))) %>% 
  mutate(cdr3.dist = stringdist(cdr3, olga.cdr3)) %>% 
  filter(pdb.id %in% pdb.nonred) %>% 
  filter(cdr3.dist > 5) 

olga.benchmark %>% 
  group_by(pdb.id) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  mutate(total = sum(n))
```

```{r}
olga.benchmark.res <- olga.benchmark %>% 
  select(pdb.id, chain.type.from, cdr3 = olga.cdr3) %>% 
  mutate(real = F) %>% 
  rbind(markup.new.a.sc %>% 
          select(pdb.id, chain.type.from = Gene, cdr3) %>% 
          filter(pdb.id %in% pdb.nonred) %>%  
          mutate(real = T)) %>%
  separate(cdr3, into = as.character(0:(max(nchar(.$cdr3)) - 1)), 
           sep = 1:(max(nchar(.$cdr3))), remove = F) %>% 
  melt(id = c("pdb.id", "real", "chain.type.from", "cdr3"), variable.name = "pos.from", value.name = "residue.aa.from") %>% 
  filter(residue.aa.from != "") %>% 
  mutate(pos.from = as.integer(as.character(pos.from))) 

olga.benchmark.energy <- contacts.a.new.tcrp %>% 
  select(pdb.id, chain.type.from, region.type.from, residue.index.from, residue.index.to, residue.aa.to) %>%
  merge(olga.benchmark.res,
        allow.cartesian=TRUE) %>% 
  distinct() %>% 
  merge.data.frame(tcren.mean.flat %>% 
                     melt(id = c("residue.aa.from", "residue.aa.to"), variable.name = "potential")) %>% 
  group_by(pdb.id, chain.type.from, real, cdr3, potential) %>% 
  summarise(pot.value = -sum(value)) 
```
```{r}
olga.benchmark.energy %>% 
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~chain.type.from)

olga.benchmark.energy %>% 
  filter(potential %in% c("cdrpa.70", "cdrps.70", "cdrpa.nonsym.70")) %>%  #%>% #potential == "cdrpa.nonsym.70") %>% 
  ggplot(aes(x = real, y = pot.value)) +
  geom_quasirandom(size = .5) +
  facet_wrap(~chain.type.from + potential, ncol = 3, scales = "free")

for (chain in c("TRA", "TRB")) {
  print(chain)
  olga.benchmark.energy %>%
    filter(chain.type.from == chain) %>% 
    mutate(group = real, value = pot.value) %>% 
    calc_roc_auc()
}

olga.benchmark.energy %>% 
  #filter(pdb.id %in% pdb.list.vdjdb) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(n.vdjdb.entries = n()) %>% 
  filter(n.vdjdb.entries > 100) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  facet_wrap(~chain.type.from) +
  geom_quasirandom(size = .5) +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw() +
  facet_wrap(~chain.type.from)
```

### Paired OLGA
```{r}
olga.benchmark.sel <- olga.benchmark.energy %>% 
  select(pdb.id, chain.type.from, real, cdr3) %>% 
  distinct %>% 
  group_by(pdb.id, chain.type.from, real) %>% 
  sample_n(min(n(), 30))

olga.benchmark.energy.paired <- olga.benchmark.energy %>% 
  ungroup %>% 
  merge(olga.benchmark.sel) %>% 
  filter(chain.type.from == "TRA") %>% 
  select(pdb.id, real, cdr3a = cdr3, potential, cdr3a.pot.value = pot.value) %>% 
  merge(olga.benchmark.energy %>% 
          ungroup %>% 
          merge(olga.benchmark.sel) %>% 
          filter(chain.type.from == "TRB") %>% 
          select(pdb.id, real, cdr3b = cdr3, potential, cdr3b.pot.value = pot.value)) %>% 
  mutate(pot.value = cdr3a.pot.value + cdr3b.pot.value)
```

```{r}
olga.benchmark.energy.paired %>% 
  mutate(group = real, value = pot.value) %>% 
  plot_roc_curve() 

olga.benchmark.energy.paired %>% 
  filter(potential %in% c("cdrpa.70", "cdrps.70", "cdrpa.nonsym.70")) %>%  #%>% #potential == "cdrpa.nonsym.70") %>% 
  ggplot(aes(x = real, y = pot.value)) +
  geom_quasirandom(size = .5) +
  facet_wrap(~potential, ncol = 3, scales = "free")

olga.benchmark.energy.paired %>%
  mutate(group = real, value = pot.value) %>% 
  calc_roc_auc()

olga.benchmark.energy.paired %>% 
  #filter(pdb.id %in% pdb.list.vdjdb) %>% 
  group_by(pdb.id, potential) %>% 
  mutate(n.vdjdb.entries = n()) %>% 
  filter(n.vdjdb.entries > 100) %>% 
  mutate(value.rank = rank(pot.value) / n()) %>% 
  filter(real) %>% 
  ggplot(aes(x = potential, y = value.rank)) +
  geom_quasirandom(size = .5) +
  geom_boxplot(color = 'red', alpha = 0) +
  scale_x_discrete(guide = guide_axis(angle = 30)) +
  theme_bw() 
```


## Correlation of TCRen and parameters of complexes
```{r}
contacts.pdb.cdr <- df_contacts("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/") %>% 
  filter(contact == 1) %>% 
  merge(compute_TCRen(pdb.nonred, "70") %>% 
          select(residue.aa.from, residue.aa.to, TCRen = cdrpa.70)) %>% 
  mutate(TCRen = -TCRen) %>% 
  group_by(pdb.id, chain.type.from, region.type.from) %>% 
  summarise(contacts = n(),
            TCRen.s = sum(TCRen)) %>% 
  merge.data.frame(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/markup.txt") %>%
          merge(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/general.txt")) %>%
          mutate(len.from = region.end - region.start + 1) %>% 
          select(pdb.id, chain.type.from = chain.type, region.type.from = region.type, len.from) %>% 
          filter(startsWith(region.type.from, "CDR")), 
        all.y = T) %>% 
  merge.data.frame(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/general.txt") %>%
                     filter(chain.type == "MHCa") %>% 
                     select(pdb.id, mhc.class = chain.supertype, mhc.allele = allele.info),
                   all.x = T) %>% 
  merge.data.frame(fread("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/general.txt") %>%
                     filter(chain.type == "PEPTIDE") %>% 
                     select(pdb.id, len.to = seq.length, peptide = allele.info),
                   all.x = T) %>% 
  mutate(contacts = replace_na(contacts, 0),
         TCRen.s = replace_na(TCRen.s, 0)) %>% 
  filter(len.to > 0, len.to < 30) %>% 
  filter(pdb.id %in% pdb.nonred)
```

```{r}
potentials %>% select(residue.aa.from, residue.aa.to, TCRen = cdrpa) %>% 
  .$TCRen %>% 
  mean()

potentials %>% 
  group_by(residue.aa.from) %>% 
  summarise(E1 = mean(cdrps))
```

CDR3
```{r}
contacts.pdb.cdr %>% 
  filter(region.type.from == "CDR3") %>% 
  select(pdb.id, chain.type.from, contacts) %>% 
  dcast(pdb.id ~ chain.type.from) %>% 
  ggplot(aes(x = TRA, y = TRB)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() +
  ggtitle("Number of contacts CDR3-peptide")

contacts.pdb.cdr %>% 
  filter(region.type.from == "CDR3") %>% 
  select(pdb.id, chain.type.from, TCRen.s) %>% 
  dcast(pdb.id ~ chain.type.from) %>% 
  ggplot(aes(x = TRA, y = TRB)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() +
  ggtitle("cdrpa for CDR3-peptide")

contacts.pdb.cdr %>% 
  filter(region.type.from == "CDR3") %>% 
  ggplot(aes(x = contacts, y = TCRen.s)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() 

contacts.pdb.cdr %>% 
  filter(region.type.from == "CDR3") %>% 
  mutate(TCRen.mean = TCRen.s / contacts) %>% 
  ggplot(aes(x = contacts, y = TCRen.mean)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() 
```

CDR1/2/3
```{r}
contacts.pdb.cdr %>% 
  filter(startsWith(region.type.from, "CDR")) %>% 
  group_by(pdb.id, chain.type.from) %>% 
  summarise(contacts = sum(contacts)) %>% 
  select(pdb.id, chain.type.from, contacts) %>% 
  dcast(pdb.id ~ chain.type.from) %>% 
  ggplot(aes(x = TRA, y = TRB)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() +
  ggtitle("Number of contacts CDR1/2/3-peptide")

contacts.pdb.cdr %>% 
  filter(startsWith(region.type.from, "CDR")) %>% 
  group_by(pdb.id, chain.type.from) %>% 
  summarise(TCRen.s = sum(TCRen.s)) %>% 
  select(pdb.id, chain.type.from, TCRen.s) %>% 
  dcast(pdb.id ~ chain.type.from) %>% 
  ggplot(aes(x = TRA, y = TRB)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() +
  ggtitle("cdrpa for CDR1/2/3-peptide")

contacts.pdb.cdr %>% 
  filter(startsWith(region.type.from, "CDR")) %>% 
  group_by(pdb.id, chain.type.from) %>% 
  summarise(contacts = sum(contacts),
            TCRen.s = sum(TCRen.s)) %>% 
  ggplot(aes(x = contacts, y = TCRen.s)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() 

contacts.pdb.cdr %>% 
  filter(startsWith(region.type.from, "CDR")) %>% 
  group_by(pdb.id, chain.type.from) %>% 
  summarise(contacts = sum(contacts),
            TCRen.s = sum(TCRen.s)) %>% 
  mutate(TCRen.mean = TCRen.s / contacts) %>% 
  ggplot(aes(x = contacts, y = TCRen.mean)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  theme_bw() 
```


```{r}
df_contacts("~/shared-with-me/struct2020/benchmark/new_PDBs/out_mir/") %>% 
  filter(contact == 1) %>% 
  filter(pdb.id == "6cw6_al2.pdb")
```

```{r}
contacts.all.e.s2.v %>% 
  ungroup %>% 
  filter(real,
         perspective == 'cdr') %>% 
  select(pdb.id = pdb.id.from, cdrps.70.s) %>% 
  .$cdrps.70.s %>% 
  qplot(.)
  #fwrite("~/shared-with-me/nCov2019_structures/energies_Vadim/PDB_TCRen.csv")
```


## Pictures for presentation
```{r}
markup.new %>% 
  filter(chain.type == "MHCb") %>% 
  select(pdb.id, complex.species, allele.info) %>% 
  distinct() %>% 
  mutate(mhc.class = ifelse(allele.info == "B2M", "MHCI", "MHCII")) %>% 
  #merge(mhc.classes %>% select(pdb.id, mhc.class)) %>% 
  merge(pdb.new_old) %>% 
  group_by(complex.species, mhc.class) %>% 
  summarise(n = n())

pdb.new_old %>% 
  group_by(group) %>% 
  summarise(n = n()) %>% 
  arrange(-n)
```

```{r}
library("PerformanceAnalytics")

q <- compute_TCRen(pdb_nonred_list(0), "all") %>% 
  merge(compute_TCRen(pdb_nonred_list(.3), "30")) %>% 
  merge(compute_TCRen(pdb_nonred_list(.5), "50")) %>% 
  merge(compute_TCRen(pdb_nonred_list(.7), "70")) 

q %>%  
  select(residue.aa.from, residue.aa.to, cdrpa.nonsym.all, cdrpa.nonsym.70) %>% 
  mutate(dif = cdrpa.nonsym.70 - cdrpa.nonsym.all) %>% 
  arrange(dif)

q %>% 
  select(residue.aa.from, residue.aa.to, cdrpa.nonsym.all, cdrpa.nonsym.30, cdrpa.nonsym.50, cdrpa.nonsym.70) %>%
  #select(residue.aa.from, residue.aa.to, cdrps.all, cdrps.30, cdrps.50, cdrps.70) %>%
  .[,-c(1,2)] %>% 
  chart.Correlation(histogram=TRUE, pch=19)
```

## Clustering of PDB based on similariy of CDRs and peptide
```{r}
markup.new.cdrp <- markup.new %>% 
  filter(pdb.id %in% mhc.classes$pdb.id) %>% 
  filter(region.type %in% c("PEPTIDE", "CDR1", "CDR2", "CDR3")) %>% 
  select(pdb.id, chain.type, region.type, region.sequence)

pdb.dist <- expand.grid(pdb.id.from = markup.new$pdb.id %>% unique(),
            pdb.id.to = markup.new$pdb.id %>% unique()) %>% 
  merge(markup.new.cdrp %>% 
          rename(pdb.id.from = pdb.id,
                 seq.from = region.sequence)) %>% 
  merge(markup.new.cdrp %>% 
          rename(pdb.id.to = pdb.id,
                 seq.to = region.sequence)) %>% 
  rowwise() %>% 
  mutate(seq.dist = stringdist(seq.from, seq.to, method = "dl"),
         max.len = max(nchar(seq.to), nchar(seq.from)),
         seq.dist.norm = seq.dist / max(nchar(seq.to), nchar(seq.from)))
```

```{r}
pdb.dist.s <- pdb.dist %>% 
  group_by(pdb.id.from, pdb.id.to) %>% 
  summarise(dist = sum(seq.dist),
            max.dist = sum(max.len),
            dist.norm = dist / max.dist) 

qplot(pdb.dist.s$dist.norm)
```

```{r}
pdb.clusters.seq <- hclust(pdb.dist.s %>% select(pdb.id.from, pdb.id.to, dist.norm) %>% dcast(pdb.id.from ~ pdb.id.to) %>% column_to_rownames("pdb.id.from") %>% as.dist(.))

plot(pdb.clusters.seq, #hang = -1, 
     cex = 0.5) 

pdb.clusters.seq %>% 
  cutree(h = .5) %>% max()
```
```{r}
pdb.new_old %>% 
  
```



```{r}
pdb.dist.s %>% 
  select(pdb.id.from, pdb.id.to, dist, dist.norm) %>% 
  merge(pdb.contacts.dist.a %>% 
          select(pdb.id.from, pdb.id.to, dist.cont = dist)) %>% 
  ggplot(aes(x = dist.norm, y = dist.cont)) +
  geom_point(size = .5)
```

```{r}
pdb.dist.s %>% 
  select(pdb.id.from, pdb.id.to, dist, dist.norm) %>% 
  merge(pdb.contacts.dist.a %>% 
          select(pdb.id.from, pdb.id.to, dist.cont = dist)) %>% 
  filter(dist.cont > 0.75,
         dist.norm < 0.1)
```
## Gee2018 test
```{r}
gee2018.contacts <- df_contacts("benchmark/Gee2018/out_mir/") %>% 
  filter(contact == 1) %>% 
  mutate(chain.supertype.from = "TRAB",
         chain.supertype.to = "PEPTIDE")

gee2018.contacts %>% 
  group_by(pdb.id) %>% 
  summarise(n = n())

gee2018.peptides <- 
  fread("benchmark/Gee2018/peptides_display.txt") %>%
  rename(peptide.pdb = peptide) %>% 
  mutate(pep.length = nchar(peptide.pdb)) %>% 
  slice(rep(1:n(), each = 1000)) %>% 
  rowwise() %>% 
  mutate(peptide = paste0(stri_rand_strings(1, 1, aa.re), substr(peptide.pdb, 2, 2), stri_rand_strings(1, pep.length-3, aa.re), substr(peptide.pdb, pep.length, pep.length))) %>% 
  select(pdb.id, peptide) %>% 
  mutate(group = F) %>% 
  rbind(fread("benchmark/Gee2018/peptides_display.txt") %>% 
          mutate(group = T)) %>% 
  group_by(pdb.id, group) %>% 
  sample_n(min(n(), 1000)) %>% 
  filter(pdb.id != "4B") %>% 
  mutate(pdb.id = paste0("Gee2018_", pdb.id, ".pdb"))

gee2018.energy <- pep_mut(gee2018.contacts$pdb.id %>% unique(), gee2018.peptides, tcren.mean.flat, gee2018.contacts)
```

```{r, fig.width=10, fig.height=5}
gee2018.energy %>% 
  mutate(value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~pdb.id)

for (pdb in gee2018.contacts$pdb.id %>% unique()) {
  print(pdb)
  gee2018.energy %>%
    filter(pdb.id == pdb) %>% 
    mutate(value = pot.value) %>% 
    calc_roc_auc()
}
```

## Adams2015 test
```{r}
adams2015.peptides <- fread("benchmark/Adams2015/peptides_Adams2015.txt") %>% 
  rename(peptide.pdb = peptide) %>% 
  mutate(pep.length = nchar(peptide.pdb)) %>% 
  slice(rep(1:n(), each = 1000)) %>% 
  rowwise() %>% 
  mutate(peptide = paste0(stri_rand_strings(1, 1, aa.re), substr(peptide.pdb, 2, 2), stri_rand_strings(1, pep.length-3, aa.re), substr(peptide.pdb, pep.length, pep.length))) %>% 
  select(peptide) %>% 
  mutate(group = F) %>% 
  rbind(fread("benchmark/Adams2015/peptides_Adams2015.txt") %>% 
          mutate(group = T)) %>% 
  group_by(group) %>% 
  sample_n(min(n(), 200)) %>% 
  merge(fread("benchmark/Adams2015/pdbs_Adams2015.txt") %>% 
          mutate(pdb.id = paste0(tolower(pdb.id), "_al2.pdb")))
  
(adams2015.peptides$pdb.id %>%  unique) 
(contacts.a.new$pdb.id %>% unique())

adams2015.energy <- pep_mut(adams2015.peptides$pdb.id %>%  unique, adams2015.peptides, tcren.mean.flat)
```
```{r, fig.width=10, fig.height=5}
adams2015.energy %>% 
  mutate(value = pot.value) %>% 
  plot_roc_curve() +
  facet_wrap(~pdb.id)

for (pdb in adams2015.energy$pdb.id %>% unique()) {
  print(pdb)
  adams2015.energy %>%
    filter(pdb.id == pdb) %>% 
    mutate(value = pot.value) %>% 
    calc_roc_auc()
}
```
