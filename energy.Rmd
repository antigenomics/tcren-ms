---
title: "Statistical potential for CDR:antigen contacts"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(forcats)
library(ggrepel)
library(broom)
```

```{r}
contacts <- fread("out/atomdist.txt") %>%
  filter(dist <= 5, chain.id.from != chain.id.to) %>%
  select(-atom.from, -atom.to, -dist) %>%
  unique

contacts.1 <- contacts
contacts.1$chain.id.from <- contacts$chain.id.to
contacts.1$chain.id.to <- contacts$chain.id.from
contacts.1$residue.index.from <- contacts$residue.index.to
contacts.1$residue.index.to <- contacts$residue.index.from

contacts <- contacts %>%
  rbind(contacts.1)
```

```{r}
resmarkup <- fread("out/resmarkup.txt", blank.lines.skip = T)

general <- fread("out/general.txt")

resmarkup.a <- resmarkup %>%
  merge(general)

contacts.a <- contacts %>%
  merge(resmarkup.a %>% mutate(chain.id.from = chain.id,
                               chain.type.from = chain.type,
                               chain.supertype.from = chain.supertype,
                               region.type.from = region.type,
                               residue.index.from = residue.index,
                               residue.aa.from = residue.aa) %>%
          select(pdb.id, chain.id.from, chain.type.from, chain.supertype.from,
                 complex.species,
                 region.type.from, residue.index.from, residue.aa.from)) %>%
  merge(resmarkup.a %>% mutate(chain.id.to = chain.id,
                               chain.type.to = chain.type,
                               chain.supertype.to = chain.supertype,
                               region.type.to = region.type,
                               residue.index.to = residue.index,
                               residue.aa.to = residue.aa) %>%
          select(pdb.id, chain.id.to, chain.type.to, chain.supertype.to,
                 region.type.to, residue.index.to, residue.aa.to)) #%>%
  #select(-pdb.id) %>%
  #unique

#contacts.a %>%
#  filter(chain.supertype.to == "PEPTIDE") %>%
#  nrow

#contacts.a %>%
#  filter(chain.supertype.from == "PEPTIDE") %>%
#  nrow
```

Summarize

```{r}
contacts.a.1 <- contacts.a %>%
  filter(chain.supertype.from != chain.supertype.to) %>%
  group_by(type = "all", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

contacts.a.2 <- contacts.a %>%
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE" | 
           startsWith(region.type.to, "CDR") & region.type.from == "PEPTIDE") %>%
  group_by(type = "cdrps", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

contacts.a.3 <- contacts.a %>%
  filter(startsWith(region.type.from, "CDR") & region.type.to == "PEPTIDE") %>%
  group_by(type = "cdrpa", residue.aa.from, residue.aa.to) %>%
  summarize(count = n())

#contacts.a.4 <- contacts.a %>%
#  filter(startsWith(region.type.from, "CDR") & startsWith(region.type.to, "CDR")) %>%
#  group_by(type = "cdrpx", residue.aa.from, residue.aa.to) %>%
#  summarize(count = n())
```



```{r}
aas <- unique(contacts.a.1$residue.aa.from)
tmp <- expand.grid(type = c("all", "cdrps", "cdrpa"),
                   residue.aa.from = aas, 
                   residue.aa.to = aas) %>%
  as.data.frame
contacts.a.x <- list(
  contacts.a.1,
  contacts.a.2,
  contacts.a.3#,
  #contacts.a.4
) %>%
  rbindlist %>%
  merge(tmp, all = T) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  mutate(count = count + 1)
```

Normalize

```{r}
contacts.a.s <- contacts.a.x %>%
  group_by(type, residue.aa.from) %>%
  mutate(total.to = sum(count)) %>%
  group_by(type, residue.aa.to) %>%
  mutate(total.from = sum(count)) %>%
  ungroup %>%
  group_by(type) %>%
  mutate(total = sum(count)) %>%
  ungroup %>%
  mutate(odds = log(count * total / total.to / total.from))
```

Symmetrize (for cdrpa)

```{r}
contacts.a.s.1 <- contacts.a.s
contacts.a.s.1$residue.aa.to <- contacts.a.s$residue.aa.from
contacts.a.s.1$residue.aa.from <- contacts.a.s$residue.aa.to

contacts.a.s <- contacts.a.s %>%
  rbind(contacts.a.s.1) %>%
  group_by(type, residue.aa.from, residue.aa.to) %>%
  summarize(count = mean(count),
            total.to = mean(total.to),
            total.from = mean(total.from),
            total = mean(total),
            odds = mean(odds))

contacts.a.s <- contacts.a.s %>%
  group_by(type, residue.aa.from) %>%
  mutate(E1 = -mean(odds)) %>%
  group_by(type, residue.aa.to) %>%
  mutate(E2 = -mean(odds)) %>%
  group_by(type) %>%
  mutate(E12 = -odds - E1 - E2) %>%
  ungroup
```

```{r}
contacts.a.s %>%
  filter(type == "cdrpa") %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = count)) +
  geom_tile() +
  geom_text(aes(label = round(count))) +
  scale_fill_distiller(palette = "Blues", direction = 1) +
  xlab("") + ylab("") +
  theme_minimal() +
  theme(aspect = 1) 

contacts.a.s %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = odds)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral", limits = c(-2.9, 2.9)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1) 

contacts.a.s %>%
  ggplot(aes(x = residue.aa.from, y = residue.aa.to, fill = E12)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral", limits = c(-2.3, 2.3)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1)

contacts.a.s %>%
  select(type, residue.aa.from, E1) %>%
  unique %>%
  ggplot(aes(x = residue.aa.from, y = E1, fill = E1)) +
  geom_bar(stat = "identity", color = "black") +
  scale_fill_distiller(palette = "Spectral", limits = c(-0.4, 0.4)) +
  xlab("") + ylab("") +
  facet_wrap(~type) +
  theme_minimal() +
  theme(aspect = 1)
```

```{r}
imgt.classes <- tibble(
  aa = c("A", "I", "L", "V",
         "R", "H", "K",
         "C", "M",
         "S", "T",
         "D", "E",
         "N", "Q",
         "F", "W", "Y",
         "G", "P"),
  cls = c("aliphatic","aliphatic","aliphatic","aliphatic",
          "basic","basic","basic",
          "sulfur","sulfur",
          "hydroxyl","hydroxyl",
          "acidic","acidic",
          "amide","amide",
          "aromatic", "aromatic","aromatic",
          "aliphatic","aliphatic")#"G", "P")
)
```

```{r}
contacts.a.s %>%
  select(type, residue.aa.from, residue.aa.to, odds) %>%
  group_by(type) %>%
  spread(residue.aa.from, value = "odds") %>%
  nest() %>%
  mutate(pca = map(data, ~ prcomp(.x %>% column_to_rownames("residue.aa.to"), center = T, scale = T))) %>%
  mutate(pca_aug = map2(pca, data, ~augment(.x, data = .y %>% column_to_rownames("residue.aa.to")))) %>%
  unnest(pca_aug) %>%
  mutate(aa = .rownames) %>%
  merge(imgt.classes) %>%
  ggplot(aes(x = .fittedPC1,
             y = .fittedPC2,
             label = aa,
             color = cls)) +
  geom_text() +
  facet_wrap(~type) +
  scale_color_brewer(palette = "Paired") +
  theme_minimal() +
  theme(legend.position = "bottom", aspect = 1) +
  labs(x="PC1", y="PC2")
```

### Testing energy on real & shuffled complexes

Select Human MHCI

```{r}
general.filtered <- general %>% 
  filter(complex.species == "Human") %>%
  group_by(pdb.id) %>%
  mutate(is.class1 = any(chain.supertype == "MHCI")) %>%
  filter(is.class1) %>%
  select(-is.class1)
```

CDR3 residues and length (from)

```{r}
resides.from <- resmarkup %>%
  merge(general.filtered) %>%
  filter(startsWith(region.type, "CDR3")) %>%
  mutate(pdb.id.from = pdb.id,
         chain.type.from = chain.type,
         region.type.from = region.type,
         residue.index.from = residue.index,
         residue.aa.from = residue.aa) %>%
  group_by(pdb.id.from, chain.type.from, region.type.from) %>%
  mutate(pos.from = residue.index.from - min(residue.index.from),
         len.from = max(pos.from) + 1) %>%
  select(pdb.id.from, chain.type.from, region.type.from, residue.index.from, 
         pos.from, len.from, residue.aa.from) %>%
  ungroup %>%
  arrange(pdb.id.from, chain.type.from, residue.index.from)
```

Peptide residues and length (from)

```{r}
resides.to <- resmarkup %>%
  merge(general.filtered) %>%
  filter(region.type == "PEPTIDE") %>%
  mutate(pdb.id.to = pdb.id,
         chain.type.to = chain.type,
         region.type.to = region.type,
         residue.index.to = residue.index,
         residue.aa.to = residue.aa) %>%
  group_by(pdb.id.to, chain.type.to, region.type.to) %>%
  mutate(pos.to = residue.index.to - min(residue.index.to),
         len.to = max(pos.to) + 1) %>%
  select(pdb.id.to, chain.type.to, region.type.to, residue.index.to, 
         pos.to, len.to, residue.aa.to) %>%
  ungroup %>%
  arrange(pdb.id.to, chain.type.to, residue.index.to)
```

Select PDB ids for combinations with CDR3 and peptide lengths matching real ones for both CDR3 and peptide

```{r}
comb.sel <- merge(
  resides.from %>%
    mutate(pdb.id = pdb.id.from,
           cdr3.len = len.from) %>%
    select(pdb.id, chain.type.from, cdr3.len) %>%
    unique,
  resides.to %>%
    mutate(pdb.id = pdb.id.to,
           pep.len = len.to) %>%
    select(pdb.id, pep.len) %>%
    unique
)

comb.sel <- merge(
  comb.sel %>%
    select(pdb.id.from = pdb.id,
           chain.type.from,
           cdr3.len.from = cdr3.len,
           pep.len.from = pep.len),
  comb.sel %>%
    select(pdb.id.to = pdb.id,
           chain.type.from,
           cdr3.len.to = cdr3.len,
           pep.len.to = pep.len)
) %>%
  filter(cdr3.len.from == cdr3.len.to,
         pep.len.from == pep.len.to) %>%
  mutate(real = pdb.id.from == pdb.id.to) %>%
  select(-cdr3.len.from, -cdr3.len.to, -pep.len.from, -pep.len.to)
```

All combinations of PDB pairs with same CDR3 and peptide length

```{r}
resides.comb <- comb.sel %>%
  merge(resides.from) %>%
  merge(resides.to)
```

Get contacts for real complexes

```{r}
contacts.real <- resides.comb %>%
  filter(real) %>%
  merge(contacts.a %>%
          filter(region.type.from == "CDR3", chain.type.to == "PEPTIDE") %>%
          mutate(pdb.id.from = pdb.id, chain.type.from, contact = 1) %>%
          select(pdb.id.from, chain.type.from, residue.index.from, residue.index.to, contact),
        all.x = T) %>%
  mutate(contact = ifelse(is.na(contact), 0, contact))
```

Append information on contacts. For mock complexes we either use contacts from TCR or peptide side ('perspective')

```{r}
contacts.all <- rbind(
  resides.comb %>%
    merge(contacts.real %>%
            mutate(perspective = "cdr") %>%
            select(perspective, pdb.id.from, chain.type.from, pos.from, pos.to, contact)),
  resides.comb %>%
    merge(contacts.real %>%
            mutate(perspective = "pep") %>%
            select(perspective, pdb.id.to, chain.type.from, pos.from, pos.to, contact))
)
```

Append energy information

```{r}
contacts.all.e <- contacts.all %>%
  # from - cdr, to - peptide
  # pos - zero based
  #id pos.from pos.to residue.aa.from residue.aa.to contact
  merge(contacts.a.s %>%
          filter(type == "cdrpa") %>%
          select(residue.aa.from, residue.aa.to, odds, E12, E1, E2)) # somewhat less due to 'X'
```

Simple odds summary

```{r}
contacts.all.e.s1 <- contacts.all.e %>%
  group_by(real, pdb.id.from, pdb.id.to, chain.type.from, perspective) %>% # group by id, chain
  summarize(odds.s = sum(odds * contact),
            e12.s = sum(E12 * contact),
            e1.s = sum((pos.to == 0) * E1),
            e1tr.s = sum((pos.to == 0 & pos.from > 3 & pos.from < len.from - 4) * E1),
            e2.s = sum((pos.from == 0) * E2))
```

```{r}
contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = -odds.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1tr.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = -odds.s - e1.s - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)

contacts.all.e.s1 %>%
  ggplot(aes(color = real, x = e12.s  - e1tr.s - e2.s)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_grid(chain.type.from ~ perspective)
```

```{r}
contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = real, x = etot)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  stat_ecdf() +
  facet_wrap(~perspective)

contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(odds.s = sum(odds.s)) %>%
  ggplot(aes(color = real, x = fct_reorder(pdb.id.from, odds.s) %>% as.integer, y = odds.s)) +
  geom_smooth() +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  geom_point() +
  facet_wrap(~perspective)

contacts.all.e.s1 %>%
  #filter(perspective == "cdr") %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = real, x = fct_reorder(pdb.id.from, etot) %>% as.integer, y = etot)) +
  geom_smooth() +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  geom_point() +
  facet_wrap(~perspective)
```

```{r}
contacts.all.e.s1 %>%
  filter(perspective == "cdr",
         pdb.id.from %in% c("6am5_al2.pdb", "3qdg_al2.pdb", "6amu_al2.pdb")) %>%
  group_by(perspective, real, pdb.id.from, pdb.id.to) %>%
  summarize(etot = sum(e12.s  - e1tr.s - e2.s)) %>%
  ggplot(aes(color = real, x = pdb.id.from,#2 * fct_reorder(pdb.id.from, etot) %>% as.integer, 
             y = etot)) +
  #geom_violin() +
  #geom_boxplot(width = 0.2) +
  geom_text_repel(aes(label = str_replace(pdb.id.to, "_al2.pdb", "")), nudge_x = 1) +
  geom_point() +
  xlab("TCR from")
```